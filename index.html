<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Belajar Perkalian & Pembagian ‚Äî v5.0</title>
<style>
:root{--bg:#f7f9fc;--panel:#fff;--primary:#0b76c2;--accent:#0ea5a3;--muted:#6b7280;--card-radius:12px;--nav-height:64px;--grid-size:110px}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:#071220}
.app{max-width:580px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding-bottom:calc(var(--nav-height)+12px)}
header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:10px 14px;border-bottom-left-radius:14px;border-bottom-right-radius:14px;display:flex;align-items:center;gap:8px;justify-content:space-between}
.header-left{display:flex;gap:8px;align-items:center}
#headerBack{background:transparent;border:none;color:white;font-weight:700;cursor:pointer;padding:6px 8px;border-radius:8px;display:flex;align-items:center;gap:6px}
#headerBack .ico{font-size:1.2rem}
.header-title{font-weight:700}
.container{padding:12px;flex:1;display:flex;flex-direction:column;gap:10px}
.card{background:var(--panel);border-radius:var(--card-radius);padding:12px;box-shadow:0 6px 18px rgba(12,18,30,0.06)}
/* Primary Button: Blue background, White text */
.btn{display:inline-block;padding:8px 12px;border-radius:10px;background:var(--primary);color:white;border:none;font-weight:600;cursor:pointer}
/* Secondary Button (Dark BG compatible): Transparent/White border & text */
.btn.secondary{display:inline-block;padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.25);color:white;font-weight:700;cursor:pointer}
/* New Outline Button (Light BG compatible): Primary color border & text */
.btn.outline{
  display:inline-block;
  padding:8px 12px;
  border-radius:10px;
  background:transparent;
  border:2px solid var(--primary);
  color:var(--primary);
  font-weight:700;
  cursor:pointer
}
.small{font-size:0.82rem;color:var(--muted)}
.mul-grid{display:flex;gap:8px;overflow:auto;padding-bottom:8px}
.mul-col{min-width:140px;flex:0 0 auto;padding:12px;border-radius:12px;color:white;font-weight:700}
.mcq-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.mcq-btn{padding:14px;border-radius:12px;border:1px solid #e6eef6;background:#fff;font-weight:800;cursor:pointer;font-size:1.05rem}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.progress-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;justify-items:center}
/* PERUBAHAN REVISI FINAL: prog-box diubah menjadi persegi panjang */
.prog-box{
  min-width: 90px;
  min-height: 80px;
  border-radius:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:1.05rem;
  cursor:pointer;
  border:2px solid rgba(0,0,0,0.06);
  padding:8px 6px; /* Tambahkan padding agar lebih lapang */
  text-align:center
}
.prog-box .label{font-size:0.9rem}
.prog-box .icon{font-size:1.4rem;margin-top:6px}
.prog-box.red{background:#fff6f6;border-color:#fca5a5;color:#991b1b}
.prog-box.yellow{background:#fffbeb;border-color:#fcd34d;color:#92400e}
.prog-box.green{background:#ecfdf5;border-color:#34d399;color:#064e3b}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.key{padding:12px;border-radius:10px;background:#f3f4f6;font-weight:700;text-align:center;font-size:1.05rem;cursor:pointer;border:1px solid #e6e9ee}
.question{font-size:1.7rem;font-weight:800;text-align:center}
.input-display{padding:10px;border-radius:10px;background:#fff;border:1px solid #e6eef6;font-weight:800;min-width:50%;text-align:center;font-size:1.3rem;margin:8px auto}
footer.app-footer{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:center;padding:8px;background:transparent;z-index:40}
.nav{width:100%;max-width:580px;background:var(--panel);box-shadow:0 -8px 20px rgba(3,10,20,0.06);border-top-left-radius:12px;border-top-right-radius:12px;height:var(--nav-height);display:flex;align-items:center;justify-content:space-around;padding:6px;gap:6px;flex-wrap:wrap}
.nav button{flex:1;border:none;background:transparent;font-weight:700;color:var(--muted);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;padding:8px;border-radius:8px}
.nav button.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:white}
#konsep h3{color:var(--primary)}
#konsep ul{margin-top:0;margin-bottom:8px;padding-left:20px}

/* --- NEW PARAMETER BUTTON STYLES --- */
.param-grid {
  display: flex;
  gap: 8px;
  flex-wrap: wrap; 
  margin-top: 4px;
  margin-bottom: 8px;
}
.param-btn {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid #e6eef6;
  background: #f3f4f6;
  font-weight: 700;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.1s ease-in-out;
}
.param-btn.selected {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* --------------------------------- */

@media (max-width:420px){
  /* PERUBAHAN REVISI FINAL: Sesuaikan ukuran prog-box yang lebih kecil untuk mobile */
  .prog-box{min-width:80px;min-height:70px;font-size:0.95rem;padding:6px 4px}
  .prog-box .icon{font-size:1.1rem}
  .nav button span{font-size:11px}
  .question{font-size:1.4rem}
  .input-display{font-size:1.1rem}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-left">
      <button id="headerBack" onclick="headerBack()" title="Kembali"><span class="ico">‚Üê</span> <span id="headerBackText"></span></button>
      <div>
        <div class="header-title">Belajar Perkalian & Pembagian</div>
        <div style="font-size:11px;opacity:0.95">oleh MD.Prasojo ‚Äî SMPN 05 Lumajang (v5.0)</div>
      </div>
    </div>
    <div>
      <button class="btn secondary" id="headerHome" onclick="navigate('cover')">Home</button>
    </div>
  </header>

  <div class="container">
    <div id="mainMenu" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Menu Utama</strong>
        <div class="small" id="miniIdent">- | - | -</div>
      </div>
      <div style="height:8px"></div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div class="card" onclick="navigate('cover')" style="cursor:pointer"><strong>Home / Identitas</strong><div class="small">Nama, Kelas, No. Absen</div></div>
        <div class="card" onclick="navigate('konsep')" style="cursor:pointer"><strong>Konsep</strong><div class="small">Perkalian & Pembagian</div></div>
        <div class="card" onclick="navigate('daftar')" style="cursor:pointer"><strong>Daftar Perkalian</strong><div class="small">1‚Äì10, 1‚Äì5, 6‚Äì10</div></div>
        <div class="card" onclick="navigate('drill')" style="cursor:pointer"><strong>Latihan Drill</strong><div class="small">Per-tabel ‚Äî Isian / MCQ</div></div>
        <div class="card" onclick="navigate('progress')" style="cursor:pointer"><strong>Progres Belajar</strong><div class="small">Perkalian 1‚Äì10</div></div>
        <div class="card" onclick="navigate('latihan_mul')" style="cursor:pointer"><strong>Latihan Perkalian</strong><div class="small">Kelompok / Acak</div></div>
        <div class="card" onclick="navigate('latihan_div')" style="cursor:pointer"><strong>Latihan Pembagian</strong><div class="small">Pembagian bilangan asli</div></div>
        <div class="card" onclick="navigate('riwayat')" style="cursor:pointer"><strong>Riwayat & Bagikan</strong><div class="small">Hasil & WA Guru</div></div>
      </div>
    </div>

    <div id="cover" class="card" style="display:none">
      <h2>Selamat Datang</h2>
      <div class="small">Isi identitas siswa. Data tersimpan otomatis di perangkat dan akan muncul lagi saat aplikasi dibuka.</div>
      <div style="height:8px"></div>
      <div class="small">Isilah dengan nama lengkap, jangan diganti dengan nama yang lain agar progress belajar dan riwayat tidak terhapus.</div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="inputName" placeholder="Nama siswa" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
        <input id="inputClass" placeholder="Kelas (mis. 7A)" style="width:120px;padding:8px;border-radius:8px;border:1px solid #ddd" />
        <input id="inputAbsen" placeholder="No. Absen" style="width:100px;padding:8px;border-radius:8px;border:1px solid #ddd" />
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="saveIdentity()">Simpan & Mulai</button>
        <button class="btn outline" onclick="clearIdentity()">Hapus Identitas</button>
      </div>
      <div style="height:8px"></div>
      <div class="small">Nama: <span id="showName">-</span> | Kelas: <span id="showClass">-</span> | Absen: <span id="showAbsen">-</span></div>
    </div>

    <div id="konsep" class="card" style="display:none">
      <h2>Konsep Perkalian dan Pembagian</h2>
      <h3>Konsep Perkalian</h3>
      <p>Perkalian adalah penjumlahan berulang dari bilangan yang sama.</p>
      <p>Contoh:</p>
      <ul>
        <li>3 √ó 4 = 4 + 4 + 4 = 12</li>
        <li>5 √ó 2 = 2 + 2 + 2 + 2 + 2 = 10</li>
      </ul>

      <h3>Konsep Pembagian</h3>
      <p>Pembagian adalah kebalikan dari perkalian. Artinya, kita mencari berapa kali suatu bilangan dapat dimasukkan ke bilangan lain.</p>
      <p>Contoh:</p>
      <ul>
        <li>12 √∑ 4 = 3 karena 3 √ó 4 = 12</li>
        <li>15 √∑ 5 = 3 karena 3 √ó 5 = 15</li>
      </ul>
      
      <h3>Sifat Komutatif</h3>
      <p>Komutatif pada perkalian adalah sifat yang menyatakan bahwa urutan angka yang dikalikan boleh ditukar dan hasilnya tetap sama. Dalam bentuk umum:ùëé√óùëè=ùëè√óùëé</p>
      <p>Contoh:</p>
      <ul>
        <li>3 x 4 = 4 x 3 = 12</li>
        <li>2 x 5 = 5 x 2 = 10</li>
      </ul>
      
      <p><strong>Catatan:</strong> Jika kamu sudah memahami perkalian, maka pembagian akan terasa lebih mudah karena keduanya saling berkaitan.</p>
    </div>

    <div id="daftar" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Daftar Perkalian</strong>
        <div><select id="mulSelect" onchange="renderMul()"><option value="1">Perkalian 1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="1-5">Perkalian 1‚Äì5</option><option value="6-10">Perkalian 6‚Äì10</option></select></div>
      </div>
      <div style="height:8px"></div>
      <div id="mulGrid" class="mul-grid" aria-live="polite"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn outline" onclick="goBack()">Kembali</button><button class="btn" onclick="navigate('drill')">Mulai Drill</button></div>
    </div>

    <div id="drill" class="card" style="display:none">
      <strong>Latihan Drill ‚Äî Perkalian Spesifik</strong>
      <div style="height:8px"></div>
      <div class="small">Pilih tabel, jumlah, kesulitan, dan mode (Isian / Pilihan Ganda).</div>
      <div style="height:8px"></div>
      
      <div style="display:flex;gap:8px;flex-direction:column;">
        <label class="small">Tabel:</label>
        <select id="drillMul" style="padding:8px;border-radius:8px;border:1px solid #ddd;">
            <option value="1">Perkalian 1</option><option value="2">Perkalian 2</option><option value="3">Perkalian 3</option><option value="4">Perkalian 4</option><option value="5">Perkalian 5</option><option value="6">Perkalian 6</option><option value="7">Perkalian 7</option><option value="8">Perkalian 8</option><option value="9">Perkalian 9</option><option value="10">Perkalian 10</option>
        </select>
        
        <label class="small">Jumlah Soal:</label>
        <div id="drillCount" class="param-grid" data-param="count">
          <button class="param-btn" data-value="5">5 Soal</button>
          <button class="param-btn selected" data-value="10">10 Soal</button>
          <button class="param-btn" data-value="15">15 Soal</button>
        </div>
        
        <label class="small">Kesulitan (Waktu/Soal):</label>
        <div id="drillDiff" class="param-grid" data-param="diff">
          <button class="param-btn" data-value="15">Mudah (15 s)</button>
          <button class="param-btn selected" data-value="10">Sedang (10 s)</button>
          <button class="param-btn" data-value="5">Sukar (5 s)</button>
        </div>
        
        <label class="small">Mode Jawaban:</label>
        <div id="drillMode" class="param-grid" data-param="mode">
          <button class="param-btn selected" data-value="mcq">Pilihan Ganda</button>
          <button class="param-btn" data-value="input">Isian</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="startDrill()">Mulai Drill</button><button class="btn outline" onclick="goBack()">Kembali</button></div>
    </div>

    <div id="progress" class="card" style="display:none">
      <strong>Progres Belajar</strong>
      <div style="height:8px"></div>
      <div class="small">Identitas: <span id="progIdent">-</span></div>
      <div style="height:8px"></div>
      <div class="small">Warna: hijau = hafal, kuning = belum hafal, merah = belum pernah dikerjakan.</div>
      <div style="height:8px"></div>
      <div class="small">Dinyatakan menguasai (hijau) jika telah menyelesaikan latihan Drill <strong>Kesulitan Sukar (5 s)</strong> untuk semua mode <b>isian dan PG</b> dengan jumlah soal <b>10 atau 15</b>. Klik kotak untuk melihat riwayat.</div>
      <div style="height:8px"></div>
      <div id="progressGrid" class="progress-grid"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="sendProgress()">Kirim Progres ke Guru via WhatsApp</button>
        <button class="btn outline" onclick="copyProgress()">Salin Pesan Progres</button>
      </div>
    </div>

    <div id="latihan_mul" class="card" style="display:none">
      <strong>Latihan Perkalian</strong>
      <div style="height:8px"></div>
      
      <div style="display:flex;gap:8px;flex-direction:column;">
        <label class="small">Tipe Soal:</label>
        <div id="mulType" class="param-grid" data-param="type">
          <button class="param-btn selected" data-value="1-5">Perkalian 1‚Äì5</button>
          <button class="param-btn" data-value="6-10">Perkalian 6‚Äì10</button>
          <button class="param-btn" data-value="1-10">Perkalian 1‚Äì10</button>
        </div>
        
        <label class="small">Jumlah Soal:</label>
        <div id="mulCount" class="param-grid" data-param="count">
          <button class="param-btn" data-value="5">5 Soal</button>
          <button class="param-btn selected" data-value="10">10 Soal</button>
          <button class="param-btn" data-value="15">15 Soal</button>
        </div>
        
        <label class="small">Kesulitan (Waktu/Soal):</label>
        <div id="mulDiff" class="param-grid" data-param="diff">
          <button class="param-btn" data-value="15">Mudah (15 s)</button>
          <button class="param-btn selected" data-value="10">Sedang (10 s)</button>
          <button class="param-btn" data-value="5">Sukar (5 s)</button>
        </div>
        
        <label class="small">Mode Jawaban:</label>
        <div id="mulMode" class="param-grid" data-param="mode">
          <button class="param-btn selected" data-value="mcq">Pilihan Ganda</button>
          <button class="param-btn" data-value="input">Isian</button>

        </div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="startMulPractice()">Mulai Latihan</button><button class="btn outline" onclick="goBack()">Kembali</button></div>
    </div>

    <div id="latihan_div" class="card" style="display:none">
      <strong>Latihan Pembagian</strong>
      <div style="height:8px"></div>
      
      <div style="display:flex;gap:8px;flex-direction:column;">
        <label class="small">Jumlah Soal:</label>
        <div id="divCount" class="param-grid" data-param="count">
          <button class="param-btn" data-value="5">5 Soal</button>
          <button class="param-btn selected" data-value="10">10 Soal</button>
          <button class="param-btn" data-value="15">15 Soal</button>
        </div>
        
        <label class="small">Kesulitan (Waktu/Soal):</label>
        <div id="divDiff" class="param-grid" data-param="diff">
          <button class="param-btn" data-value="15">Mudah (15 s)</button>
          <button class="param-btn selected" data-value="10">Sedang (10 s)</button>
          <button class="param-btn" data-value="5">Sukar (5 s)</button>
        </div>

        <label class="small">Range Pembagian (Maks. Pembagi):</label>
        <div id="divRange" class="param-grid" data-param="range">
          <button class="param-btn selected" data-value="1-10">1‚Äì10</button>
          <button class="param-btn" data-value="1-20">1‚Äì20</button>
        </div>
        
        <label class="small">Mode Jawaban:</label>
        <div id="divMode" class="param-grid" data-param="mode">
          <button class="param-btn selected" data-value="mcq">Pilihan Ganda</button>
          <button class="param-btn" data-value="input">Isian</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="startDivPractice()">Mulai Pembagian</button><button class="btn outline" onclick="goBack()">Kembali</button></div>
    </div>

    <div id="quizView" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Soal <span id="qIndex">1</span> / <span id="qTotal">10</span></div>
        <div style="display:flex;align-items:center;gap:8px"><div class="small timer" id="timer">00:10</div><div style="width:120px" class="progress"><div id="progressBar" style="width:100%"></div></div></div>
      </div>
      <div style="padding:12px;text-align:center">
        <div class="question" id="questionText">3 √ó 4 = ?</div>
        <div class="small" id="infoText"></div>

        <div id="mcqArea" style="display:none"><div class="mcq-grid" id="mcqOptions"></div></div>

        <div id="inputArea">
          <div class="input-display" id="answerDisplay">-</div>
          <div class="keypad" id="keypad">
            <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
            <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
            <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
            <div class="key" onclick="pressKey('0')">0</div><div class="key" onclick="pressBack()">‚Üê</div><div class="key" onclick="submitAnswer()">OK</div>
          </div>
        </div>

      </div>
      <div style="display:flex;gap:8px;justify-content:flex-start; margin-top: 10px;">
        <button class="btn outline" onclick="endQuizEarly()">Seleselesaikan Lebih Awal</button>
      </div>
    </div>

    <div id="resultView" class="card" style="display:none">
      <h3>Hasil Latihan</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div class="small">Benar</div><div id="resCorrect" style="font-weight:800"></div></div>
        <div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div class="small">Salah</div><div id="resWrong" style="font-weight:800"></div></div>
        <div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div class="small">Nilai</div><div id="resScore" style="font-weight:800"></div></div>
      </div>
      <div style="height:8px"></div>
      <div class="small">Waktu pengerjaan: <span id="resTime">00:00</span></div>
      <div style="height:8px"></div>
      <div class="small">Nama: <span id="resName">-</span> | Kelas: <span id="resClass">-</span> | Absen: <span id="resAbsen">-</span></div>
      <div style="height:8px"></div>
      <div class="wrong-list" id="wrongList"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="doneBtn">Selesai</button>
        <button class="btn outline" id="replayBtn">Ulangi Soal</button>
        <button class="btn outline" onclick="goBack()">Kembali</button>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn outline" id="shareWhats">Kirim ke Guru via WhatsApp</button>
        <button class="btn outline" id="copyResult">Salin Pesan</button>
      </div>
      <div id="sharePreview" style="margin-top:8px" class="small"></div>
    </div>

    <div id="riwayat" class="card" style="display:none">
      <strong>Riwayat Latihan</strong>
      <div style="height:8px"></div>
      <div class="small">Identitas: <span id="histIdent">-</span></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="sendAllHistory()">Kirim Semua ke Guru</button>
        <button class="btn outline" onclick="copyAllHistory()">Salin Semua Riwayat</button>
        <button class="btn outline" onclick="clearAllHistory()">Hapus Semua Riwayat</button>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label class="small">Nomor Guru (WA):
          <input id="teacherNumber" placeholder="62..." style="padding:6px;border-radius:8px;border:1px solid #ddd;margin-left:6px" />
        </label>
        <button class="btn" onclick="saveTeacher()">Simpan Nomor</button>
        <div class="small" id="teacherSaved" style="margin-left:8px"></div>
      </div>
      <div style="height:8px"></div>
      <div class="table-scroll"><div id="historyList"></div></div>
    </div>

  </div>

  <footer class="app-footer">
    <nav class="nav" role="navigation" aria-label="navigasi utama">
      <button id="navHome" onclick="navClick('cover')">üè†<span>Home</span></button>
      <button id="navDaftar" onclick="navClick('daftar')">üìò<span>Daftar</span></button>
      <button id="navDrill" onclick="navClick('drill')">üß©<span>Drill</span></button>
      <button id="navProgress" onclick="navClick('progress')">üìà<span>Progres</span></button>
      <button id="navKali" onclick="navClick('latihan_mul')">‚úñÔ∏è<span>Kali</span></button>
      <button id="navBagi" onclick="navClick('latihan_div')">‚ûó<span>Bagi</span></button>
      <button id="navRiwayat" onclick="navClick('riwayat')">üìä<span>Riwayat</span></button>
    </nav>
  </footer>
</div>

<script>
/* Keys */
const LS_KEY_ID = 'bppi_identity_v4.6';
const LS_KEY_HISTORY = 'bppi_history_v4.6';
const LS_KEY_TEACHER = 'bppi_teacher_v4.6';
const LS_KEY_PROGRESS = 'bppi_progress_v4.6';

/* Navigation + panels */
let currentPanel=null, historyStack=[];
function showPanel(id){ const panels=['mainMenu','cover','konsep','daftar','drill','progress','latihan_mul','latihan_div','quizView','resultView','riwayat']; panels.forEach(p=>{ const el=document.getElementById(p); if(el) el.style.display=(p===id)?'block':'none'; }); currentPanel=id; updateNavActive(); updateHeaderBackVisibility(); }
function navigate(id){ if(currentPanel && currentPanel!==id) historyStack.push(currentPanel); showPanel(id); }
function navClick(id){ if(currentPanel && currentPanel!==id) historyStack.push(currentPanel); showPanel(id); }
function goBack(){ if(historyStack.length>0) showPanel(historyStack.pop()); else showPanel('mainMenu'); }
function headerBack(){ goBack(); }
function updateNavActive(){ [['navHome','cover'],['navDaftar','daftar'],['navDrill','drill'],['navProgress','progress'],['navKali','latihan_mul'],['navBagi','latihan_div'],['navRiwayat','riwayat']].forEach(pair=>{ const el=document.getElementById(pair[0]); if(!el) return; el.classList.toggle('active', currentPanel===pair[1]); }); }
function updateHeaderBackVisibility(){ const btn=document.getElementById('headerBack'); if(!btn) return; // hide on cover/mainMenu
  if(currentPanel==='cover' || currentPanel==='mainMenu') btn.style.display='none'; else btn.style.display='inline-flex'; }

/* Identity */
function loadIdentityObj(){ const raw=localStorage.getItem(LS_KEY_ID); return raw?JSON.parse(raw):{name:'',cls:'',abs:''}; }
function loadIdentity(){ const raw=localStorage.getItem(LS_KEY_ID); if(raw){ try{ const o=JSON.parse(raw); document.getElementById('inputName').value=o.name||''; document.getElementById('inputClass').value=o.cls||''; document.getElementById('inputAbsen').value=o.abs||''; updateIdentityDisplay(o.name,o.cls,o.abs); document.getElementById('miniIdent').innerText=(o.name||'-')+' | '+(o.cls||'-')+' | '+(o.abs||'-'); document.getElementById('progIdent').innerText=(o.name||'-')+' | '+(o.cls||'-')+' | Absen: '+(o.abs||'-'); 
  // PERUBAHAN REVISI FINAL: Tambahkan update histIdent
  document.getElementById('histIdent').innerText=(o.name||'-')+' | '+(o.cls||'-')+' | Absen: '+(o.abs||'-');
}catch(e){} } else { updateIdentityDisplay('-','-','-'); document.getElementById('miniIdent').innerText='- | - | -'; document.getElementById('progIdent').innerText='-'; 
  // PERUBAHAN REVISI FINAL: Tambahkan update histIdent
  document.getElementById('histIdent').innerText='-';
} }
function saveIdentityFromInputs(){
  const n=document.getElementById('inputName').value.trim();
  const c=document.getElementById('inputClass').value.trim();
  const a=document.getElementById('inputAbsen').value.trim();
  const currentId = loadIdentityObj();
  const isChanged = (currentId.name !== n || currentId.cls !== c || currentId.abs !== a);

  if(isChanged && (currentId.name || currentId.cls || currentId.abs)) {
      if(!confirm('Yakin akan mengganti identitas? Semua Progres Belajar dan Riwayat Latihan yang tersimpan akan dihapus untuk menjaga keakuratan data. Lanjutkan?')) {
          // kembalikan nilai input ke identitas tersimpan
          document.getElementById('inputName').value = currentId.name;
          document.getElementById('inputClass').value = currentId.cls;
          document.getElementById('inputAbsen').value = currentId.abs;
          return false;
      }
      // Hapus riwayat dan progres jika identitas berubah dan konfirmasi OK
      localStorage.removeItem(LS_KEY_HISTORY);
      localStorage.removeItem(LS_KEY_PROGRESS);
      renderHistory();
      renderProgressGrid();
      alert('Identitas berhasil diganti. Riwayat dan Progres Belajar telah dihapus.');
  }

  localStorage.setItem(LS_KEY_ID, JSON.stringify({name:n,cls:c,abs:a}));
  updateIdentityDisplay(n,c,a);
  document.getElementById('miniIdent').innerText=(n||'-')+' | '+(c||'-')+' | '+(a||'-');
  document.getElementById('progIdent').innerText=(n||'-')+' | '+(c||'-')+' | Absen: '+(a||'-');
  // PERUBAHAN REVISI FINAL: Tambahkan update histIdent
  document.getElementById('histIdent').innerText=(n||'-')+' | '+(c||'-')+' | Absen: '+(a||'-');
  return true;
}
function saveIdentity(){
    if(saveIdentityFromInputs()){
        setTimeout(()=> showPanel('mainMenu'),100);
    }
}
function updateIdentityDisplay(n,c,a){ document.getElementById('showName').innerText = n||'-'; document.getElementById('showClass').innerText = c||'-'; document.getElementById('showAbsen').innerText = a||'-'; }
function clearIdentity(){
  if(!confirm('Hapus identitas dari perangkat? Riwayat dan Progres Belajar juga akan terhapus.')) return;
  localStorage.removeItem(LS_KEY_ID);
  localStorage.removeItem(LS_KEY_HISTORY);
  localStorage.removeItem(LS_KEY_PROGRESS);
  document.getElementById('inputName').value=''; document.getElementById('inputClass').value=''; document.getElementById('inputAbsen').value='';
  updateIdentityDisplay('-','-','-');
  document.getElementById('miniIdent').innerText='- | - | -';
  document.getElementById('progIdent').innerText='-';
  // PERUBAHAN REVISI FINAL: Tambahkan update histIdent
  document.getElementById('histIdent').innerText='-';
  renderHistory();
  renderProgressGrid();
  alert('Identitas, Riwayat, dan Progres Belajar dihapus.');
}

/* Mul rendering */
const MUL_COLORS=['#2b8cff','#2ecc71','#f3d66a','#f29d43','#b28fe6','#0b76c2','#16a34a','#f59e0b','#f97316','#9333ea'];
function renderMul(){ const sel=document.getElementById('mulSelect').value; const grid=document.getElementById('mulGrid'); grid.innerHTML=''; if(sel.includes('-')){ const p=sel.split('-'); const from=parseInt(p[0]); const to=parseInt(p[1]); for(let n=from;n<=to;n++) grid.appendChild(createMulCol(n)); } else grid.appendChild(createMulCol(parseInt(sel))); }
function createMulCol(n){ const div=document.createElement('div'); div.className='mul-col'; const color=MUL_COLORS[(n-1)%MUL_COLORS.length]; div.style.background=`linear-gradient(180deg, ${shade(color,0.06)}, ${color})`; const h=document.createElement('h4'); h.innerText='Perkalian '+n; div.appendChild(h); for(let i=1;i<=10;i++){ const p=document.createElement('p'); p.innerText = i+' √ó '+n+' = '+(i*n); p.style.margin='4px 0'; div.appendChild(p); } return div; }
function shade(hex,percent){ try{ const c=hex.replace('#',''); const num=parseInt(c,16); let r=(num>>16)+Math.round(255*percent); let g=((num>>8)&0x00FF)+Math.round(255*percent); let b=(num&0x0000FF)+Math.round(255*percent); r=Math.min(255,r); g=Math.min(255,g); b=Math.min(255,b); return '#'+((r<<16)|(g<<8)|b).toString(16).padStart(6,'0'); }catch(e){return hex;} }

// --- NEW HELPER FUNCTIONS FOR PARAMETER BUTTONS ---
function getSelectedParam(id){
    const el = document.getElementById(id);
    const selectedBtn = el.querySelector('.param-btn.selected');
    return selectedBtn ? selectedBtn.dataset.value : null;
}
function setupParamButtons(){
    document.querySelectorAll('.param-grid').forEach(grid => {
        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('param-btn')) {
                // Hapus kelas 'selected' dari semua tombol di grid ini
                grid.querySelectorAll('.param-btn').forEach(btn => btn.classList.remove('selected'));
                // Tambahkan kelas 'selected' pada tombol yang diklik
                e.target.classList.add('selected');
            }
        });
    });
}
// ----------------------------------------------------

/* Quiz engine */
let quizState=null, quizCallbackReplay=null, returnPanelAfterQuiz=null; // returnPanelAfterQuiz added

// MODIFIKASI: Menggunakan getSelectedParam
function startDrill(){
    const table=parseInt(document.getElementById('drillMul').value,10);
    const count=parseInt(getSelectedParam('drillCount'),10);
    const per=parseInt(getSelectedParam('drillDiff'),10);
    const mode=getSelectedParam('drillMode');

    let pool=[]; for(let i=1;i<=10;i++) pool.push({q:i+'√ó'+table,a:i*table,tExp:per, meta:{kind:'Drill',table:table,mode:mode,difficulty:per,count:count}}); pool=shuffle(pool);
    if(count>10){ while(pool.length<count){ const r=Math.floor(Math.random()*10)+1; pool.push({q:r+'√ó'+table,a:r*table,tExp:per, meta:{kind:'Drill',table:table,mode:mode,difficulty:per,count:count}}); } }
    const list=pool.slice(0,count);
    quizCallbackReplay=()=>startDrill();
    returnPanelAfterQuiz='drill'; // Set return panel for Drill
    startQuiz({list, perDefault:per, type:'Drill', drillMode:mode, detail:`Drill Perkalian ${table} (${labelDifficulty(per)})`, meta:{table:table, mode:mode, difficulty:per, count:count}});
}

// Revisi 2: Tambahkan mode ke startMulPractice
function startMulPractice(){
    const type=getSelectedParam('mulType');
    const count=parseInt(getSelectedParam('mulCount'),10);
    const per=parseInt(getSelectedParam('mulDiff'),10);
    const mode=getSelectedParam('mulMode'); // <<< BARU: Ambil Mode
    
    let pool=[]; 
    if(type==='1-5'){ // Perkalian 1-5 (1x1 s/d 10x5)
        for(let a=1;a<=10;a++) for(let b=1;b<=5;b++) pool.push({q:a+'√ó'+b,a:a*b,tExp:per, meta:{kind:'Latihan Perkalian',range:'1-5',mode:mode,difficulty:per,count:count}}); 
    } 
    else if(type==='6-10'){ // Perkalian 6-10 (1x6 s/d 10x10)
        for(let a=1;a<=10;a++) for(let b=6;b<=10;b++) pool.push({q:a+'√ó'+b,a:a*b,tExp:per, meta:{kind:'Latihan Perkalian',range:'6-10',mode:mode,difficulty:per,count:count}});
    }
    else if(type==='1-10') { // Perkalian 1-10 (1x1 s/d 10x10)
        for(let a=1;a<=10;a++) for(let b=1;b<=10;b++) pool.push({q:a+'√ó'+b,a:a*b,tExp:per, meta:{kind:'Latihan Perkalian',range:'1-10',mode:mode,difficulty:per,count:count}}); 
    }
    
    pool=shuffle(pool); 
    const list=pool.slice(0,count);
    quizCallbackReplay=()=>startMulPractice();
    returnPanelAfterQuiz='latihan_mul'; // Set return panel for Latihan Perkalian
    startQuiz({list, perDefault:per, type:'Latihan Perkalian', drillMode:mode, detail:`Perkalian ${type} (${labelDifficulty(per)})`, meta:{range:type, mode:mode, difficulty:per, count:count}});
}

// Revisi 2: Tambahkan mode ke startDivPractice
function startDivPractice(){
    const count=parseInt(getSelectedParam('divCount'),10);
    const per=parseInt(getSelectedParam('divDiff'),10);
    const range=getSelectedParam('divRange');
    const mode=getSelectedParam('divMode'); // <<< BARU: Ambil Mode
    
    let maxDiv = range==='1-10'?10:20; 
    let list=[];
    while(list.length<count){ 
        const divisor=Math.floor(Math.random()*maxDiv)+1; 
        const quotient=Math.floor(Math.random()*10)+1; 
        const dividend=divisor*quotient; 
        if(dividend<=100) list.push({q:dividend+' √∑ '+divisor,a:quotient,tExp:per, meta:{kind:'Latihan Pembagian',range:range,mode:mode,difficulty:per,count:count}}); // <<< BARU: Simpan Mode
    }
    quizCallbackReplay=()=>startDivPractice();
    returnPanelAfterQuiz='latihan_div'; // Set return panel for Latihan Pembagian
    startQuiz({list, perDefault:per, type:'Latihan Pembagian', drillMode:mode, detail:`Pembagian ${range} (${labelDifficulty(per)})`, meta:{range:range, mode:mode, difficulty:per, count:count}});
}
function startQuiz(opts){ if(quizState && quizState.timerId) clearInterval(quizState.timerId); quizState={ list:opts.list.slice(), index:0, answers:[], startTime:Date.now(), totalTimeUsed:0, perDefault:opts.perDefault||10, timerId:null, timeLeft:0, timePerQ:opts.perDefault||10, type:opts.type||'Latihan', drillMode:opts.drillMode||'input', detail:opts.detail||'', meta:opts.meta||{} }; document.getElementById('qTotal').innerText = quizState.list.length; document.getElementById('qIndex').innerText = 1; showPanel('quizView'); showQuestion(); enableKeyboardForQuiz(true); }
function showQuestion(){ const s=quizState; if(!s) return; if(s.index>=s.list.length){ finishQuiz(); return; } const item=s.list[s.index]; document.getElementById('questionText').innerText = item.q + ' = ?'; document.getElementById('infoText').innerText=''; document.getElementById('answerDisplay').innerText='-'; document.getElementById('qIndex').innerText = s.index+1; s.timePerQ = item.tExp || s.perDefault;
  if(s.drillMode==='mcq'){ document.getElementById('inputArea').style.display='none'; document.getElementById('mcqArea').style.display='block'; buildMCQOptions(item.a); } else { document.getElementById('mcqArea').style.display='none'; document.getElementById('inputArea').style.display='block'; }
  startTimer(s.timePerQ); s.questionStart = Date.now();
}
function buildMCQOptions(correct){ const optsEl=document.getElementById('mcqOptions'); optsEl.innerHTML=''; let choices=[correct]; while(choices.length<4){ const delta=Math.floor(Math.random()*7)+1; const sign=Math.random()<0.5?-1:1; let cand = correct + sign*delta; if(cand<=0) cand = Math.abs(cand)+2; if(!choices.includes(cand)) choices.push(cand); } choices=shuffle(choices); choices.forEach(ch=>{ const b=document.createElement('button'); b.className='mcq-btn'; b.innerText=ch; b.onclick=()=>{ const isCorrect=(ch===correct); b.classList.add('selected'); b.classList.add(isCorrect?'correct':'wrong'); setTimeout(()=>{ recordAnswer(ch,false); },300); }; optsEl.appendChild(b); }); }
function startTimer(seconds){ stopTimer(); quizState.timePerQ=seconds; quizState.timeLeft=seconds; updateTimerDisplay(quizState.timeLeft); updateProgress(); quizState.timerId=setInterval(()=>{ quizState.timeLeft--; if(quizState.timeLeft<=0){ clearInterval(quizState.timerId); quizState.timerId=null; recordAnswer(null,true); } else { updateTimerDisplay(quizState.timeLeft); updateProgress(); } },1000); }
function stopTimer(){ if(quizState && quizState.timerId){ clearInterval(quizState.timerId); quizState.timerId=null; } }
function updateTimerDisplay(sec){ const el=document.getElementById('timer'); if(el) el.innerText = (sec<60?('00:'+String(sec).padStart(2,'0')):formatSecondsToClock(sec)); }
function updateProgress(){ const pct=(quizState.timeLeft/quizState.timePerQ)*100; const bar=document.getElementById('progressBar'); if(bar) bar.style.width = pct + '%'; }
function pressKey(d){ const disp=document.getElementById('answerDisplay'); if(disp.innerText === '-') disp.innerText = d; else disp.innerText = (disp.innerText + d).replace(/^0+/, ''); }
function pressBack(){ const disp=document.getElementById('answerDisplay'); if(disp.innerText === '-') return; disp.innerText = disp.innerText.slice(0,-1) || '-'; }
function submitAnswer(){ const disp=document.getElementById('answerDisplay'); const val = (disp.innerText === '-'? null: parseInt(disp.innerText,10)); recordAnswer(val,false); }
function recordAnswer(val,timedOut){ stopTimer(); const s=quizState; const item=s.list[s.index]; const end=Date.now(); const timeUsed=Math.round((end - s.questionStart)/1000); s.totalTimeUsed += timeUsed; const expected = (typeof item.a!=='undefined')? item.a : item.aVal; const correct = (val!==null && parseInt(val,10)===expected) && !timedOut; s.answers.push({q:item.q, correct, expected, given:val, time:timeUsed, timedOut, meta:item.meta||{}}); s.index++; const mcqOpts=document.querySelectorAll('#mcqOptions .mcq-btn'); mcqOpts.forEach(b=>b.disabled=true); setTimeout(()=>{ if(s.index < s.list.length) showQuestion(); else finishQuiz(); },250); }
function finishQuiz(){
  stopTimer();
  const total=quizState.list.length;
  const correct=quizState.answers.filter(a=>a.correct).length;
  const wrong=total-correct;
  const pct=Math.round((correct/total)*100);
  const quizReturnPanel = returnPanelAfterQuiz; // capture return panel

  document.getElementById('resCorrect').innerText = correct;
  document.getElementById('resWrong').innerText = wrong;
  document.getElementById('resScore').innerText = pct+'%';
  document.getElementById('resTime').innerText = formatSecondsFull(quizState.totalTimeUsed);
  const id=loadIdentityObj();
  document.getElementById('resName').innerText = id.name||'-';
  document.getElementById('resClass').innerText = id.cls||'-';
  document.getElementById('resAbsen').innerText = id.abs||'-';
  const wl=document.getElementById('wrongList'); wl.innerHTML='';
  quizState.answers.forEach((a,i)=>{
    const d=document.createElement('div');
    d.style.padding='6px'; d.style.borderBottom='1px solid #f3f3f3';
    d.innerHTML = '<strong>'+(i+1)+'.</strong> '+a.q+' = <strong>'+a.expected+'</strong><br/><span class="small">Jawaban: '+(a.given===null?'‚Äî':a.given)+(a.timedOut? ' (waktu habis)':'')+' | Waktu: '+a.time+' s</span>';
    if(!a.correct) d.style.background='#fff7f7';
    wl.appendChild(d);
  });

  // auto save history
  const entry = { idName:id.name||'', idClass:id.cls||'', idAbsen:id.abs||'', type: quizState.type||'', detail: quizState.detail||'', count: quizState.list.length, correct: correct, wrong: wrong, score: pct, timeSecs: quizState.totalTimeUsed, date: (new Date()).toISOString(), metaSummary: extractMetaSummary(quizState), meta: quizState.meta||{} };
  addHistoryEntry(entry);
  // update progress
  updateProgressDataFromEntry(entry);
  // prepare share preview
  prepareSharePreview();

  // FIX 3: bind done button -> return to correct panel
  document.getElementById('doneBtn').onclick = ()=> {
    alert('Selesai. Hasil tersimpan di Riwayat.');
    showPanel(quizReturnPanel || 'mainMenu'); // Kembali ke panel latihan yang sesuai
    enableKeyboardForQuiz(false);
  };
  // FIX 4: bind replay button
  document.getElementById('replayBtn').onclick = ()=> {
    if(typeof quizCallbackReplay==='function') quizCallbackReplay();
    else alert('Tidak ada sesi untuk diulang.');
  };

  showPanel('resultView');
  renderProgressGrid();
  renderHistory();
}

/* History management */
function loadHistory(){ const raw=localStorage.getItem(LS_KEY_HISTORY); return raw?JSON.parse(raw):[]; }
function saveHistory(hist){ localStorage.setItem(LS_KEY_HISTORY, JSON.stringify(hist)); }
function addHistoryEntry(entry){ const hist = loadHistory(); hist.unshift(entry); saveHistory(hist); renderHistory(); }
function clearAllHistory(){ if(!confirm('Hapus SEMUA riwayat latihan? Tindakan ini tidak dapat dibatalkan. Riwayat dan Progres Belajar akan hilang.')) return; localStorage.removeItem(LS_KEY_HISTORY); localStorage.removeItem(LS_KEY_PROGRESS); renderHistory(); renderProgressGrid(); alert('Semua riwayat dan progres berhasil dihapus.'); }

// PERUBAHAN REVISI FINAL: Menghapus kolom Nama, Kelas, No. Absen dari tabel
function renderHistory(){ 
  const hist = loadHistory(); 
  const container=document.getElementById('historyList'); 
  container.innerHTML=''; 
  if(hist.length===0){ container.innerHTML='<div class="small">Belum ada riwayat latihan.</div>'; return; }
  
  const table=document.createElement('table'); 
  table.className='hist'; 
  table.style.width='100%'; 
  table.style.borderCollapse='collapse'; 
  
  const thead=document.createElement('thead'); 
  // PERUBAHAN: Hanya menyisakan kolom yang relevan (tanpa identitas siswa)
  thead.innerHTML='<tr><th>No</th><th>Tanggal</th><th>Jenis</th><th>Detail</th><th>Mode</th><th>Skor</th><th>Benar</th><th>Waktu</th><th>Aksi</th></tr>'; 
  table.appendChild(thead);
  
  const tbody=document.createElement('tbody');
  hist.forEach((h,idx)=>{ 
    const modeLabel = h.meta && h.meta.mode ? (h.meta.mode === 'mcq' ? 'PG' : 'Isian') : '-'; 
    const tr=document.createElement('tr'); 
    const date=new Date(h.date).toLocaleString(); 
    // PERUBAHAN: Menghilangkan h.idName, h.idClass, h.idAbsen dari <td>
    tr.innerHTML=`<td style="text-align:center">${idx+1}</td><td>${date}</td><td>${h.type}</td><td>${h.detail||'-'}</td><td style="text-align:center">${modeLabel}</td><td style="text-align:center">${h.score}%</td><td style="text-align:center">${h.correct}</td><td>${formatSecondsFull(h.timeSecs)}</td><td></td>`; 
    const cell=tr.querySelector('td:last-child'); 
    const sendBtn=document.createElement('button'); 
    sendBtn.className='btn outline'; 
    sendBtn.style.marginRight='6px'; 
    sendBtn.innerText='Kirim'; 
    sendBtn.onclick=()=>{ previewAndSendHistoryEntry(h); }; 
    const copyBtn=document.createElement('button'); 
    copyBtn.className='btn outline'; 
    copyBtn.innerText='Salin'; 
    copyBtn.onclick=()=>{ navigator.clipboard.writeText(makeMessageFromEntry(h)).then(()=> alert('Pesan disalin.')); }; 
    cell.appendChild(sendBtn); 
    cell.appendChild(copyBtn); 
    tbody.appendChild(tr); 
  });
  table.appendChild(tbody); 
  container.appendChild(table); 
}

/* send/copy all history */
// Revisi 1: Tambahkan mode pada pesan yang dikirim/disalin
function makeMessageFromEntry(h){ 
    const modeLabel = h.meta && h.meta.mode ? (h.meta.mode === 'mcq' ? 'Pilihan Ganda' : 'Isian') : '-';
    return `Hasil Latihan:\nNama: ${h.idName||'-'}\nKelas: ${h.idClass||'-'}\nNo. Absen: ${h.idAbsen||'-'}\nJenis: ${h.type}\nDetail: ${h.detail||'-'}\nMode: ${modeLabel}\nSkor: ${h.score}%\nBenar: ${h.correct} | Salah: ${h.wrong}\nWaktu: ${formatSecondsFull(h.timeSecs)}\nTanggal: ${new Date(h.date).toLocaleString()}`; 
}
function previewAndSendHistoryEntry(entry){ const saved=localStorage.getItem(LS_KEY_TEACHER); if(!saved){ if(confirm('Nomor guru belum disimpan. Mau salin pesan untuk dikirim manual?')){ navigator.clipboard.writeText(makeMessageFromEntry(entry)).then(()=> alert('Pesan disalin.')); } return; } const url='https://wa.me/'+saved+'?text='+encodeURIComponent(makeMessageFromEntry(entry)); window.open(url,'_blank'); }
function sendAllHistory(){
  const hist=loadHistory();
  if(hist.length===0){ alert('Belum ada riwayat untuk dikirim.'); return; }
  const id=loadIdentityObj();
  const saved=localStorage.getItem(LS_KEY_TEACHER);
  // FIX 5: Tambahkan identitas siswa di awal pesan
  let full='*Data Siswa:*%0ANama:%20'+encodeURIComponent(id.name||'-')+'%0AKelas:%20'+encodeURIComponent(id.cls||'-')+'%0ANo.%20Absen:%20'+encodeURIComponent(id.abs||'-')+'%0A%0A*Rekap Riwayat Latihan (Terbaru):*%0A';
  hist.forEach((h,idx)=>{
    full += encodeURIComponent(`${idx+1}. ${h.type} - ${h.detail||'-'} - Skor ${h.score}% - ${formatSecondsFull(h.timeSecs)} - ${new Date(h.date).toLocaleDateString('id-ID')}\n`);
  });
  if(!saved){
    if(confirm('Nomor guru belum disimpan. Mau salin pesan lengkap untuk dikirim manual?')){
      navigator.clipboard.writeText(decodeURIComponent(full).replace(/%0A/g, '\n').replace(/%20/g, ' ')).then(() => alert('Pesan rekap disalin.'));
    }
    return;
  }
  const url='https://wa.me/'+saved+'?text='+full;
  window.open(url,'_blank');
}
function copyAllHistory(){
  const hist=loadHistory();
  if(hist.length===0){ alert('Belum ada riwayat.'); return; }
  const id=loadIdentityObj();
  // FIX 5: Tambahkan identitas siswa di awal pesan
  let text=`Data Siswa:\nNama: ${id.name||'-'}\nKelas: ${id.cls||'-'}\nNo. Absen: ${id.abs||'-'}\n\nRekap Riwayat Latihan (Terbaru):\n`;
  hist.forEach((h,idx)=>{
    text += `${idx+1}. ${h.type} - ${h.detail||'-'} - Skor ${h.score}% - ${formatSecondsFull(h.timeSecs)} - ${new Date(h.date).toLocaleDateString('id-ID')}\n`;
  });
  navigator.clipboard.writeText(text).then(()=> alert('Rekap riwayat disalin.'));
}

/* Teacher phone */
function formatPhone(input){ let s=input.replace(/\s+/g,'').replace(/\+/g,''); if(s.startsWith('0')) s='62'+s.slice(1); if(!/^[0-9]{8,15}$/.test(s)) return null; return s; }
function saveTeacher(){ let num=document.getElementById('teacherNumber').value.trim(); if(!num){ localStorage.removeItem(LS_KEY_TEACHER); document.getElementById('teacherSaved').innerText='Nomor dihapus.'; alert('Nomor guru dihapus.'); renderHistory(); return; } const f=formatPhone(num); if(!f){ alert('Nomor tidak valid. Gunakan format Indonesia, contoh: 62812... atau 0812...'); return; } localStorage.setItem(LS_KEY_TEACHER,f); document.getElementById('teacherSaved').innerText='Nomor tersimpan: '+f; alert('Nomor guru disimpan: '+f); }

/* Progress data */
function loadProgress(){ const raw=localStorage.getItem(LS_KEY_PROGRESS); return raw?JSON.parse(raw):{}; }
function saveProgress(p){ localStorage.setItem(LS_KEY_PROGRESS, JSON.stringify(p)); }

// MODIFIKASI: Logika Mastery diperbarui untuk hanya Kesulitan 5s dan count >= 10
function updateProgressDataFromEntry(entry){
  try{
    const p = loadProgress();
    const tables = entry.metaSummary && entry.metaSummary.tables ? entry.metaSummary.tables : parseTablesFromDetail(entry.detail);
    if(tables.length===0) return;
    tables.forEach(t=>{
      if(!p[t]) p[t] = { records: [] , bestScore:0, mastered:false};
      const rec = { mode: entry.meta && entry.meta.mode ? entry.meta.mode : (entry.type && entry.type.includes('Drill') ? (entry.meta && entry.meta.mode?entry.meta.mode:'input') : 'input'), difficulty: entry.meta && entry.meta.difficulty ? entry.meta.difficulty : null, count: entry.count || 0, score: entry.score || 0, date: entry.date };
      p[t].records.push(rec);
      p[t].bestScore = Math.max(p[t].bestScore||0, entry.score||0);
      
      // >>> MODIFIKASI LOGIKA MASTERY
      const requiredDiffs = [5]; // Hanya Kesulitan Sukar (5 detik)
      const modes = ['input','mcq'];
      let mastered = true;
      for(const m of modes){
        for(const d of requiredDiffs){ 
          // Cek apakah ada record yang: mode=m, difficulty=5, count>=10, dan score>=90
          const ok = p[t].records.some(r => r.mode===m && r.difficulty==d && r.count>=10 && r.score>=90);
          if(!ok) { mastered = false; break; }
        }
        if(!mastered) break;
      }
      p[t].mastered = mastered;
      // <<< AKHIR MODIFIKASI LOGIKA MASTERY
    });
    saveProgress(p);
  }catch(e){ console.warn('updateProgressDataFromEntry failed', e); }
}
function parseTablesFromDetail(detail){
  const res=[]; if(!detail) return res;
  const mRange = detail.match(/Perkalian\s*([0-9]+)\s*[‚Äì-]\s*([0-9]+)/i); // Handle '‚Äì' (en dash) and '-' (hyphen)
  if(mRange){ const from=parseInt(mRange[1]), to=parseInt(mRange[2]); for(let i=from;i<=to;i++) res.push(i); return res; }
  const mSingle = detail.match(/Perkalian\s*([0-9]+)/i);
  if(mSingle){ res.push(parseInt(mSingle[1],10)); return res; }
  const m1to5 = detail.match(/1‚Äì5/); if(m1to5){ for(let i=1;i<=5;i++) res.push(i); return res; }
  const m1to10 = detail.match(/1‚Äì10/); if(m1to10){ for(let i=1;i<=10;i++) res.push(i); return res; }
  return res;
}

// Revisi 3: Fungsi untuk Kirim Progres
function sendProgress(){
  const p = loadProgress();
  const id = loadIdentityObj();
  const saved = localStorage.getItem(LS_KEY_TEACHER);

  if (!saved) {
    if (confirm('Nomor guru belum disimpan. Mau salin pesan progres untuk dikirim manual?')) {
      copyProgress();
    }
    return;
  }
  
  const msg = makeProgressMessage(p, id);
  const url = 'https://wa.me/' + saved + '?text=' + encodeURIComponent(msg);
  window.open(url, '_blank');
}

// Revisi 3: Fungsi untuk Salin Progres
function copyProgress(){
  const p = loadProgress();
  const id = loadIdentityObj();
  const msg = makeProgressMessage(p, id);
  navigator.clipboard.writeText(msg).then(() => alert('Pesan progres disalin.'));
}

// Revisi 3: Fungsi Helper untuk membuat pesan Progres (Format WA)
function makeProgressMessage(progressData, identity){
  let msg = `*LAPORAN PROGRES BELAJAR PERKALIAN*\n`;
  msg += `Nama: ${identity.name || '-'}\n`;
  msg += `Kelas: ${identity.cls || '-'}\n`;
  msg += `No. Absen: ${identity.abs || '-'}\n`;
  msg += `Tanggal Laporan: ${new Date().toLocaleDateString('id-ID')}\n\n`;
  msg += `*REKAP PROGRES PERKALIAN (1 - 10):*\n`;

  for(let i=1; i<=10; i++){
    const prog = progressData[i];
    let status = '‚ùå Belum Dikerjakan';
    let detail = '';
    
    if(prog && prog.records && prog.records.length > 0){
        if(prog.mastered){
            status = '‚úÖ HAFAL (LULUS)';
        } else {
            status = '‚ö†Ô∏è Belum Hafal';
        }
        detail = `(Skor terbaik: ${prog.bestScore}%)`;
    }
    msg += `‚Ä¢ Perkalian ${String(i).padStart(2,' ')}: ${status} ${detail}\n`;
  }
  
  msg += '\n*Keterangan:* \n‚úÖ Hafal (LULUS): Sudah LULUS drill (5s, skor min 90%) mode isian & PG.\n‚ö†Ô∏è Belum Hafal: Sudah pernah mengerjakan namun belum LULUS drill.\n‚ùå Belum Dikerjakan: Belum ada riwayat latihan drill.';
  
  return msg;
}

function renderProgressGrid(){ const container=document.getElementById('progressGrid'); container.innerHTML=''; const p = loadProgress();
  for(let i=1;i<=10;i++){
    const box=document.createElement('div'); box.className='prog-box';
    let state='red';
    if(p[i] && p[i].records && p[i].records.length>0){ state = p[i].mastered ? 'green' : 'yellow'; }
    box.classList.add(state);
    const label = document.createElement('div'); label.className='label'; label.innerText = 'Perkalian ' + i;
    const icon = document.createElement('div'); icon.className='icon';
    if(state==='green') icon.innerText='‚úÖ'; else if(state==='yellow') icon.innerText='‚ö†Ô∏è'; else icon.innerText='‚ùå';
    box.appendChild(label); box.appendChild(icon);
    box.onclick = ()=> {
      const recs = (p[i] && p[i].records) ? p[i].records.slice().reverse() : [];
      let msg = `Perkalian ${i}\nStatus: ${state==='green'?'Hafal':state==='yellow'?'Belum hafal':'Belum pernah'}\nSkor terbaik: ${p[i]?p[i].bestScore+'%':'-'}\n\nRiwayat (terbaru):\n`;
      if(recs.length===0) msg += '- belum ada riwayat -';
      else recs.slice(0,8).forEach((r,idx)=>{ msg += `${idx+1}. Mode:${r.mode} | Dif:${r.difficulty} | Jumlah:${r.count} | Skor:${r.score}% | ${new Date(r.date).toLocaleDateString('id-ID')}\n`; });
      alert(msg);
    };
    container.appendChild(box);
  }
}

/* helpers: extract meta summary to know which tables touched */
function extractMetaSummary(quizStateObj){
  try{
    const tables = [];
    quizStateObj.list.forEach(it => { if(it.meta && it.meta.table) tables.push(it.meta.table); else {
      const m = (it.q || '').match(/√ó\s*([0-9]+)/); if(m){ const t = parseInt(m[1],10); if(!isNaN(t)) tables.push(t); }
    }});
    const unique = Array.from(new Set(tables));
    return { tables: unique };
  }catch(e){ return {}; }
}

/* share preview */
function prepareSharePreview(){ const id=loadIdentityObj(); const total=quizState.list.length; const correct=quizState.answers.filter(a=>a.correct).length; const wrong=total-correct; const timeStr=formatSecondsFull(quizState.totalTimeUsed); const type=quizState.type||''; 
const modeLabel = quizState.meta && quizState.meta.mode ? (quizState.meta.mode === 'mcq' ? 'Pilihan Ganda' : 'Isian') : '-';
const text = `Hasil Latihan:\nNama: ${id.name||'-'}\nKelas: ${id.cls||'-'}\nNo. Absen: ${id.abs||'-'}\nJenis: ${type}\nDetail: ${quizState.detail||'-'}\nMode: ${modeLabel}\nSkor: ${Math.round((correct/total)*100)}%\nBenar: ${correct} | Salah: ${wrong}\nWaktu: ${timeStr}`; document.getElementById('sharePreview').innerText = text; document.getElementById('shareWhats').dataset.msg = encodeURIComponent(text); }

/* keyboard support for desktop ‚Äî versi perbaikan Enter/NumpadEnter */
let keyboardEnabled = false;
function enableKeyboardForQuiz(enable){
  keyboardEnabled = !!enable;
}

/* pastikan tombol Enter dan NumpadEnter keduanya berfungsi */
window.addEventListener('keydown', (e) => {
  if (!keyboardEnabled) return;
  if (currentPanel !== 'quizView') return;

  // angka dari keyboard biasa
  if (e.key >= '0' && e.key <= '9') {
    pressKey(e.key);
    e.preventDefault();
    return;
  }

  // angka dari numpad
  if (e.code && e.code.startsWith('Numpad')) {
    const d = e.code.replace('Numpad', '');
    if (!isNaN(d) && d !== 'Enter') {
      pressKey(d);
      e.preventDefault();
      return;
    }
  }

  // hapus/backspace
  if (e.key === 'Backspace' || e.code === 'Delete') {
    pressBack();
    e.preventDefault();
    return;
  }

  // Enter dari keyboard utama atau numpad
  if (e.key === 'Enter' || e.code === 'Enter' || e.code === 'NumpadEnter') {
    submitAnswer();
    e.preventDefault();
    return;
  }
});


/* finish early */
function endQuizEarly(){
    // FIX 2: Tombol Selesaikan Lebih Awal sudah ada, pastikan tampilannya benar
    if(!confirm('Akhiri latihan sekarang? Hasil akan dihitung berdasarkan soal yang telah dijawab.')) return;
    stopTimer();
    while(quizState.index < quizState.list.length){
        const item=quizState.list[quizState.index];
        const expected = (typeof item.a!=='undefined')? item.a : item.aVal;
        // Tandai sebagai salah karena tidak dijawab
        quizState.answers.push({q:item.q, correct:false, expected, given:null, time:0, timedOut:true, meta:item.meta||{}});
        quizState.index++;
    }
    finishQuiz();
}

/* helpers: escapeHtml, shuffle, formatting */
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function formatSecondsFull(sec){ if(typeof sec!=='number') sec=Number(sec)||0; if(sec<60) return sec+' detik'; const m=Math.floor(sec/60); const s=sec%60; return (m+' menit'+(s>0? ' '+s+' detik':'')); }
function formatSecondsToClock(sec){ if(sec<60) return '00:'+String(sec).padStart(2,'0'); const m=Math.floor(sec/60); const s=sec%60; return (m<10?('0'+m):m)+':'+(s<10?('0'+s):s); }
function labelDifficulty(sec){ if(sec>=15) return 'Mudah'; if(sec>=10) return 'Sedang'; return 'Sukar'; }

/* init and bindings */
document.addEventListener('DOMContentLoaded', ()=>{ 
  loadIdentity(); 
  renderMul(); 
  renderHistory(); 
  renderProgressGrid(); 
  
  // Panggil fungsi untuk menyiapkan tombol parameter
  setupParamButtons(); 
  
  const t=localStorage.getItem(LS_KEY_TEACHER); 
  if(t){ document.getElementById('teacherNumber').value=t; document.getElementById('teacherSaved').innerText='Nomor tersimpan: '+t; } 
  
  showPanel('cover'); updateNavActive();
  document.getElementById('copyResult').onclick=()=> navigator.clipboard.writeText(document.getElementById('sharePreview').innerText).then(()=> alert('Pesan disalin.'));
  document.getElementById('shareWhats').onclick=()=>{ const saved=localStorage.getItem(LS_KEY_TEACHER); if(!saved){ if(confirm('Nomor guru belum disimpan. Mau salin pesan untuk dikirim manual?')){ navigator.clipboard.writeText(document.getElementById('sharePreview').innerText).then(()=> alert('Pesan disalin.')); } return; } const msg=document.getElementById('shareWhats').dataset.msg || ''; window.open('https://wa.me/'+saved+'?text='+msg,'_blank'); };
  document.getElementById('inputName').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveIdentity(); }); document.getElementById('inputClass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveIdentity(); }); document.getElementById('inputAbsen').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveIdentity(); });
});
</script>
</body>
</html>
