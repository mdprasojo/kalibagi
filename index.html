<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Belajar Perkalian & Pembagian ‚Äî v5.7</title>
<style>
:root{--bg:#f7f9fc;--panel:#fff;--primary:#0b76c2;--accent:#0ea5a3;--muted:#6b7280;--card-radius:12px;--nav-height:64px;--grid-size:110px}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:#071220}
.app{max-width:580px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding-bottom:calc(var(--nav-height)+12px)}
header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:10px 14px;border-bottom-left-radius:14px;border-bottom-right-radius:14px;display:flex;align-items:center;gap:8px;justify-content:space-between}
.header-left{display:flex;gap:8px;align-items:center}
#headerBack{background:transparent;border:none;color:white;font-weight:700;cursor:pointer;padding:6px 8px;border-radius:8px;display:flex;align-items:center;gap:6px}
#headerBack .ico{font-size:1.2rem}
.header-title{font-weight:700}
.container{padding:12px;flex:1;display:flex;flex-direction:column;gap:10px}
.card{background:var(--panel);border-radius:var(--card-radius);padding:12px;box-shadow:0 6px 18px rgba(12,18,30,0.06)}
/* Primary Button: Blue background, White text */
.btn{display:inline-block;padding:8px 12px;border-radius:10px;background:var(--primary);color:white;border:none;font-weight:600;cursor:pointer}
/* Secondary Button (Dark BG compatible): Transparent/White border & text */
.btn.secondary{display:inline-block;padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.25);color:white;font-weight:700;cursor:pointer}
/* New Outline Button (Light BG compatible): Primary color border & text */
.btn.outline{
  display:inline-block;
  padding:8px 12px;
  border-radius:10px;
  background:transparent;
  border:2px solid var(--primary);
  color:var(--primary);
  font-weight:700;
  cursor:pointer
}
.small{font-size:0.82rem;color:var(--muted)}
.mul-grid{display:flex;gap:8px;overflow:auto;padding-bottom:8px}
.mul-col{min-width:140px;flex:0 0 auto;padding:12px;border-radius:12px;color:white;font-weight:700}
.mcq-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.mcq-btn{padding:14px;border-radius:12px;border:1px solid #e6eef6;background:#fff;font-weight:800;cursor:pointer;font-size:1.05rem}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.progress-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;justify-items:center}
/* PERUBAHAN REVISI FINAL: prog-box diubah menjadi persegi panjang */
.prog-box{
  min-width: 90px;
  min-height: 80px;
  border-radius:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:1.05rem;
  cursor:pointer;
  border:2px solid rgba(0,0,0,0.06);
  padding:8px 6px; /* Tambahkan padding agar lebih lapang */
  text-align:center
}
.prog-box .label{font-size:0.9rem}
.prog-box .icon{font-size:1.4rem;margin-top:6px}
.prog-box.red{background:#fff6f6;border-color:#fca5a5;color:#991b1b}
.prog-box.yellow{background:#fffbeb;border-color:#fcd34d;color:#92400e}
.prog-box.green{background:#ecfdf5;border-color:#34d399;color:#064e3b}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.key{padding:12px;border-radius:10px;background:#f3f4f6;font-weight:700;text-align:center;font-size:1.05rem;cursor:pointer;border:1px solid #e6e9ee}
.question{font-size:1.7rem;font-weight:800;text-align:center}
.input-display{padding:10px;border-radius:10px;background:#fff;border:1px solid #e6eef6;font-weight:800;min-width:50%;text-align:center;font-size:1.3rem;margin:8px auto}
footer.app-footer{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:center;padding:8px;background:transparent;z-index:40}
.nav{width:100%;max-width:580px;background:var(--panel);box-shadow:0 -8px 20px rgba(3,10,20,0.06);border-top-left-radius:12px;border-top-right-radius:12px;height:var(--nav-height);display:flex;align-items:center;justify-content:space-around;padding:6px;gap:6px;flex-wrap:wrap}
.nav button{flex:1;border:none;background:transparent;font-weight:700;color:var(--muted);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;padding:8px;border-radius:8px}
.nav button.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:white}
#konsep h3{color:var(--primary)}
#konsep ul{margin-top:0;margin-bottom:8px;padding-left:20px}

/* --- NEW PARAMETER BUTTON STYLES --- */
.param-grid {
  display: flex;
  gap: 8px;
  flex-wrap: wrap; 
  margin-top: 4px;
  margin-bottom: 8px;
}
.param-btn {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid #e6eef6;
  background: #f3f4f6;
  font-weight: 700;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.1s ease-in-out;
}
.param-btn.selected {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* --------------------------------- */

/* --- RIWAYAT TABLE STYLES (REVISI) --- */
.hist th, .hist td {
    padding: 8px 6px;
    border: 1px solid #e6eef6; /* Border tipis */
    text-align: center;
    font-size: 0.85rem;
}
.hist thead th {
    background-color: #e6f0f8; /* Header biru muda */
    font-weight: 700;
    color: #0b76c2;
    white-space: nowrap; /* Mencegah judul kolom terlalu pendek */
}
.hist tbody tr:nth-child(even) {
    background-color: #fcfdfe; /* Baris genap sedikit berbeda */
}
/* Penyesuaian warna baris berdasarkan skor */
.hist .score-100 { background-color: #ecfdf5; } /* Hijau Muda untuk 100% */
.hist .score-60 { background-color: #fff0f0; } /* Merah Muda untuk <60% */

/* Penyesuaian lebar kolom untuk 7 kolom (termasuk MODE) */
.hist th:nth-child(1), .hist td:nth-child(1) { width: 5%; } /* No */
.hist th:nth-child(2), .hist td:nth-child(2) { width: 12%; } /* Tanggal */
.hist th:nth-child(3), .hist td:nth-child(3) { text-align: left; width: 20%; } /* Jenis Latihan */
.hist th:nth-child(4), .hist td:nth-child(4) { text-align: left; width: 28%; } /* Detail */
.hist th:nth-child(5), .hist td:nth-child(5) { width: 10%; } /* Mode (BARU) */
.hist th:nth-child(6), .hist td:nth-child(6) { width: 10%; } /* Skor */
.hist th:nth-child(7), .hist td:nth-child(7) { width: 15%; } /* Waktu */
/* --------------------------------- */

#infoText {
    /* PENTING: Menetapkan tinggi minimum agar elemen di bawah tidak bergeser */
    min-height: 2.5em; 
    
    text-align: center;
    font-weight: bold;
    padding-top: 5px; 
    
    /* Menyembunyikan pesan saat tidak ada jawaban */
    opacity: 0; 
    transition: opacity 0.3s ease-out; 
}

/* Kelas untuk menampilkan pesan (sudah digunakan di recordAnswer) */
#infoText.show-result {
    opacity: 1; 
}

/* Kelas warna (sudah ada di file Anda) */
#infoText.correct {
    color: var(--accent); 
}
#infoText.wrong {
    color: red; 
}

@media (max-width:420px){
  /* PERUBAHAN REVISI FINAL: Sesuaikan ukuran prog-box yang lebih kecil untuk mobile */
  .prog-box{min-width:80px;min-height:70px;font-size:0.95rem;padding:6px 4px}
  .prog-box .icon{font-size:1.1rem}
  .nav button span{font-size:11px}
  .question{font-size:1.4rem}
  .input-display{font-size:1.1rem}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-left">
      <button id="headerBack" onclick="headerBack()" title="Kembali"><span class="ico">‚Üê</span> <span id="headerBackText"></span></button>
      <div>
        <div class="header-title">Belajar Perkalian & Pembagian</div>
        <div style="font-size:11px;opacity:0.95">oleh MD.Prasojo ‚Äî SMPN 05 Lumajang (v5.7)</div>
      </div>
    </div>
    <div>
      <button class="btn secondary" id="headerHome" onclick="navigate('cover')">Home</button>
    </div>
  </header>

  <div class="container">
    <div id="mainMenu" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Menu Utama</strong>
        <div class="small" id="miniIdent">- | - | -</div>
      </div>
      <div style="height:8px"></div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div class="card" onclick="navigate('cover')" style="cursor:pointer"><strong>Home / Identitas</strong><div class="small">Nama, Kelas, No. Absen</div></div>
        <div class="card" onclick="navigate('konsep')" style="cursor:pointer"><strong>Konsep</strong><div class="small">Perkalian & Pembagian</div></div>
        <div class="card" onclick="navigate('daftar')" style="cursor:pointer"><strong>Daftar Perkalian</strong><div class="small">1‚Äì10, 1‚Äì5, 6‚Äì10</div></div>
        <div class="card" onclick="navigate('drill')" style="cursor:pointer"><strong>Latihan Drill</strong><div class="small">Per-tabel ‚Äî Isian / MCQ</div></div>
        <div class="card" onclick="navigate('progress')" style="cursor:pointer"><strong>Progres Belajar</strong><div class="small">Perkalian 1‚Äì10</div></div>
        <div class="card" onclick="navigate('latihan_mul')" style="cursor:pointer"><strong>Latihan Perkalian</strong><div class="small">Kelompok / Acak</div></div>
        <div class="card" onclick="navigate('latihan_div')" style="cursor:pointer"><strong>Latihan Pembagian</strong><div class="small">Pembagian bilangan asli</div></div>
        <div class="card" onclick="navigate('riwayat')" style="cursor:pointer"><strong>Riwayat & Bagikan</strong><div class="small">Hasil & WA Guru</div></div>
      </div>
    </div>

    <div id="cover" class="card" style="display:none">
      <h2>Selamat Datang</h2>
      <div class="small">Isilah dengan nama lengkap, jangan diganti dengan nama yang lain agar progress belajar dan riwayat tidak terhapus.</div>
      <div class="small">Data tersimpan otomatis di perangkat dan akan muncul lagi saat aplikasi dibuka.</div>
      <div style="height:8px"></div>
     
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="inputName" placeholder="Nama siswa" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
        <input id="inputClass" placeholder="Kelas (mis. 7A)" style="width:120px;padding:8px;border-radius:8px;border:1px solid #ddd" />
        <input id="inputAbsen" placeholder="No. Absen" style="width:100px;padding:8px;border-radius:8px;border:1px solid #ddd" />
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="saveIdentity()">Simpan</button>
        <button class="btn outline" onclick="clearIdentity()">Hapus Identitas</button>
      </div>
      <div style="height:8px"></div>
      <div class="small">Nama: <span id="showName">-</span> | Kelas: <span id="showClass">-</span> | Absen: <span id="showAbsen">-</span></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label class="small">Nomor Guru (WA):
          <input id="teacherNumber" placeholder="62..." style="padding:6px;border-radius:8px;border:1px solid #ddd;margin-left:6px" />
        </label>
        <button class="btn" onclick="saveTeacher()">Simpan Nomor</button>
        <div class="small" id="teacherSaved" style="margin-left:8px"></div>
      </div>
    
     <div style="height:10px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Menu Utama</strong>
        </div>
      <div style="height:8px"></div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div class="card" onclick="navigate('cover')" style="cursor:pointer"><strong>Home / Identitas</strong><div class="small">Nama, Kelas, No. Absen</div></div>
        <div class="card" onclick="navigate('konsep')" style="cursor:pointer"><strong>Konsep</strong><div class="small">Perkalian & Pembagian</div></div>
        <div class="card" onclick="navigate('daftar')" style="cursor:pointer"><strong>Daftar Perkalian</strong><div class="small">1‚Äì10, 1‚Äì5, 6‚Äì10</div></div>
        <div class="card" onclick="navigate('drill')" style="cursor:pointer"><strong>Latihan Drill</strong><div class="small">Per-tabel ‚Äî Isian / MCQ</div></div>
        <div class="card" onclick="navigate('progress')" style="cursor:pointer"><strong>Progres Belajar</strong><div class="small">Perkalian 1‚Äì10</div></div>
        <div class="card" onclick="navigate('latihan_mul')" style="cursor:pointer"><strong>Latihan Perkalian</strong><div class="small">Kelompok / Acak</div></div>
        <div class="card" onclick="navigate('latihan_div')" style="cursor:pointer"><strong>Latihan Pembagian</strong><div class="small">Pembagian bilangan asli</div></div>
        <div class="card" onclick="navigate('riwayat')" style="cursor:pointer"><strong>Riwayat & Bagikan</strong><div class="small">Hasil & WA Guru</div></div>
<div style="height:40px"></div>
    </div>
    </div>

    <div id="konsep" class="card" style="display:none">
      <h2>Konsep Perkalian dan Pembagian</h2>
      <h3>Konsep Perkalian</h3>
      <p>Perkalian adalah penjumlahan berulang dari bilangan yang sama.</p>
      <p>Contoh:</p>
      <ul>
        <li>3 √ó 4 = 4 + 4 + 4 = 12</li>
        <li>5 √ó 2 = 2 + 2 + 2 + 2 + 2 = 10</li>
      </ul>

      <h3>Konsep Pembagian</h3>
      <p>Pembagian adalah kebalikan dari perkalian. Artinya, kita mencari berapa kali suatu bilangan dapat dimasukkan ke bilangan lain.</p>
      <p>Contoh:</p>
      <ul>
        <li>12 √∑ 4 = 3 karena 3 √ó 4 = 12</li>
        <li>15 √∑ 5 = 3 karena 3 √ó 5 = 15</li>
      </ul>
      
      <h3>Sifat Komutatif</h3>
      <p>Komutatif pada perkalian adalah sifat yang menyatakan bahwa urutan angka yang dikalikan boleh ditukar dan hasilnya tetap sama. Dalam bentuk umum:ùëé√óùëè=ùëè√óùëé</p>
      <p>Contoh:</p>
      <ul>
        <li>3 x 4 = 4 x 3 = 12</li>
        <li>2 x 5 = 5 x 2 = 10</li>
      </ul>
      
      <p><strong>Catatan:</strong> Jika kamu sudah memahami perkalian, maka pembagian akan terasa lebih mudah karena keduanya saling berkaitan.</p>
    </div>

    <div id="daftar" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Daftar Perkalian</strong>
        <div><select id="mulSelect" onchange="renderMul()"><option value="1">Perkalian 1</option><option value="2">Perkalian 2</option><option value="3">Perkalian 3</option><option value="4">Perkalian 4</option><option value="5">Perkalian 5</option><option value="6">Perkalian 6</option><option value="7">Perkalian 7</option><option value="8">Perkalian 8</option><option value="9">Perkalian 9</option><option value="10">Perkalian 10</option><option value="1-5">Perkalian 1‚Äì5</option><option value="6-10">Perkalian 6‚Äì10</option></select></div>
      </div>
      <div style="height:8px"></div>
      <div id="mulGrid" class="mul-grid" aria-live="polite"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn outline" onclick="goBack()">Kembali</button><button class="btn" onclick="navigate('drill')">Mulai Drill</button></div>
    </div>

    <div id="drill" class="card" style="display:none">
      <strong>Latihan Drill ‚Äî Perkalian Spesifik</strong>
      <div style="height:8px"></div>
      <div class="small">Pilih tabel, jumlah, kesulitan, dan mode (Isian / Pilihan Ganda).</div>
      <div style="height:8px"></div>
      
      <div style="display:flex;gap:8px;flex-direction:column;">
        <label class="small">Tabel:</label>
        <select id="drillMul" style="padding:8px;border-radius:8px;border:1px solid #ddd;">
            <option value="1">Perkalian 1</option><option value="2">Perkalian 2</option><option value="3">Perkalian 3</option><option value="4">Perkalian 4</option><option value="5">Perkalian 5</option><option value="6">Perkalian 6</option><option value="7">Perkalian 7</option><option value="8">Perkalian 8</option><option value="9">Perkalian 9</option><option value="10">Perkalian 10</option>
        </select>
        
        <label class="small">Jumlah Soal:</label>
        <div id="drillCount" class="param-grid" data-param="count">
          <button class="param-btn" data-value="5">5 Soal</button>
          <button class="param-btn selected" data-value="10">10 Soal</button>
          <button class="param-btn" data-value="15">15 Soal</button>
        </div>
        
        <label class="small">Kesulitan (Waktu/Soal):</label>
        <div id="drillDiff" class="param-grid" data-param="diff">
          <button class="param-btn" data-value="15">Mudah (15 s)</button>
          <button class="param-btn selected" data-value="10">Sedang (10 s)</button>
          <button class="param-btn" data-value="5">Sukar (5 s)</button>
        </div>
        
        <label class="small">Mode Jawaban:</label>
        <div id="drillMode" class="param-grid" data-param="mode">
          <button class="param-btn selected" data-value="mcq">Pilihan Ganda</button>
          <button class="param-btn" data-value="input">Isian</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="startDrill()">Mulai Drill</button><button class="btn outline" onclick="goBack()">Kembali</button></div>
      <div style="height:8px"></div>
      <div class="small">Dinyatakan menguasai (hijau, pada halaman progress) jika telah menyelesaikan latihan Drill <strong>Kesulitan Sukar (5 s)</strong> untuk semua mode <b>isian dan PG</b> dengan jumlah soal <b>10 atau 15</b>, dan mendapat skor <b>minimal 90%</b>.</div>
    </div>

    <div id="progress" class="card" style="display:none">
      <strong>Progres Belajar</strong>
      <div style="height:8px"></div>
      <div class="small">Identitas: <span id="progIdent">-</span></div>
      <div style="height:8px"></div>
      <div class="small">Warna: hijau = hafal, kuning = belum hafal, merah = belum pernah dikerjakan.</div>
      <div style="height:8px"></div>
      <div class="small">Dinyatakan menguasai (hijau) jika telah menyelesaikan latihan Drill <strong>Kesulitan Sukar (5 s)</strong> untuk semua mode <b>isian dan PG</b> dengan jumlah soal <b>10 atau 15</b>, dan mendapat skor <b>minimal 90%</b>. Klik kotak untuk melihat riwayat.</div>
      <div style="height:8px"></div>
      <div id="progressGrid" class="progress-grid"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="sendProgress()">Kirim Progres ke Guru via WhatsApp</button>
        <button class="btn outline" onclick="copyProgress()">Salin Pesan Progres</button>
      </div>
<div style="height:50px"></div>
    </div>

    <div id="latihan_mul" class="card" style="display:none">
      <strong>Latihan Perkalian</strong>
      <div style="height:8px"></div>
      
      <div style="display:flex;gap:8px;flex-direction:column;">
        <label class="small">Tipe Soal:</label>
        <div id="mulType" class="param-grid" data-param="type">
          <button class="param-btn selected" data-value="1-5">Perkalian 1‚Äì5</button>
          <button class="param-btn" data-value="6-10">Perkalian 6‚Äì10</button>
          <button class="param-btn" data-value="1-10">Perkalian 1‚Äì10</button>
        </div>
        
        <label class="small">Jumlah Soal:</label>
        <div id="mulCount" class="param-grid" data-param="count">
          <button class="param-btn" data-value="5">5 Soal</button>
          <button class="param-btn selected" data-value="10">10 Soal</button>
          <button class="param-btn" data-value="15">15 Soal</button>
        </div>
        
        <label class="small">Kesulitan (Waktu/Soal):</label>
        <div id="mulDiff" class="param-grid" data-param="diff">
          <button class="param-btn" data-value="15">Mudah (15 s)</button>
          <button class="param-btn selected" data-value="10">Sedang (10 s)</button>
          <button class="param-btn" data-value="5">Sukar (5 s)</button>
        </div>
        
        <label class="small">Mode Jawaban:</label>
        <div id="mulMode" class="param-grid" data-param="mode">
          <button class="param-btn selected" data-value="mcq">Pilihan Ganda</button>
          <button class="param-btn" data-value="input">Isian</button>

        </div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="startMulPractice()">Mulai Latihan</button><button class="btn outline" onclick="goBack()">Kembali</button></div>
    </div>

    <div id="latihan_div" class="card" style="display:none">
      <strong>Latihan Pembagian</strong>
      <div style="height:8px"></div>
      
      <div style="display:flex;gap:8px;flex-direction:column;">
        <label class="small">Jumlah Soal:</label>
        <div id="divCount" class="param-grid" data-param="count">
          <button class="param-btn" data-value="5">5 Soal</button>
          <button class="param-btn selected" data-value="10">10 Soal</button>
          <button class="param-btn" data-value="15">15 Soal</button>
        </div>
        
        <label class="small">Kesulitan (Waktu/Soal):</label>
        <div id="divDiff" class="param-grid" data-param="diff">
          <button class="param-btn" data-value="15">Mudah (15 s)</button>
          <button class="param-btn selected" data-value="10">Sedang (10 s)</button>
          <button class="param-btn" data-value="5">Sukar (5 s)</button>
        </div>

        <label class="small">Range Pembagian (Maks. Pembagi):</label>
        <div id="divRange" class="param-grid" data-param="range">
          <button class="param-btn selected" data-value="1-10">1‚Äì10</button>
          <button class="param-btn" data-value="1-20">1‚Äì20</button>
        </div>
        
        <label class="small">Mode Jawaban:</label>
        <div id="divMode" class="param-grid" data-param="mode">
          <button class="param-btn selected" data-value="mcq">Pilihan Ganda</button>
          <button class="param-btn" data-value="input">Isian</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="startDivPractice()">Mulai Pembagian</button><button class="btn outline" onclick="goBack()">Kembali</button></div>
    </div>

    <div id="quizView" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Soal <span id="qIndex">1</span> / <span id="qTotal">10</span></div>
        <div style="display:flex;align-items:center;gap:8px"><div class="small timer" id="timer">00:10</div><div style="width:120px" class="progress"><div id="progressBar" style="width:100%"></div></div></div>
      </div>
      <div style="padding:12px;text-align:center">
        <div class="question" id="questionText">3 √ó 4 = ?</div>
        <div class="small" id="infoText"></div>

        <div id="mcqArea" style="display:none"><div class="mcq-grid" id="mcqOptions"></div></div>

        <div id="inputArea">
          <div class="input-display" id="answerDisplay">-</div>
          <div class="keypad" id="keypad">
            <div class="key" onclick="pressKey('1')">1</div><div class="key" onclick="pressKey('2')">2</div><div class="key" onclick="pressKey('3')">3</div>
            <div class="key" onclick="pressKey('4')">4</div><div class="key" onclick="pressKey('5')">5</div><div class="key" onclick="pressKey('6')">6</div>
            <div class="key" onclick="pressKey('7')">7</div><div class="key" onclick="pressKey('8')">8</div><div class="key" onclick="pressKey('9')">9</div>
            <div class="key" onclick="pressKey('0')">0</div><div class="key" onclick="pressBack()">‚Üê</div><div class="key" onclick="submitAnswer()">OK</div>
          </div>
        </div>

      </div>
      <div style="display:flex;gap:8px;justify-content:flex-start; margin-top: 10px;">
        <button class="btn outline" onclick="endQuizEarly()">Selesaikan Lebih Awal</button>
      </div>
    </div>

    <div id="resultView" class="card" style="display:none">
      <h3>Hasil Latihan</h3>
      <div id="resPraise" style="margin-bottom:10px; font-size:1.1rem; text-align:center; color:#0b76c2"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div class="small">Benar</div><div id="resCorrect" style="font-weight:800"></div></div>
        <div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div class="small">Salah</div><div id="resWrong" style="font-weight:800"></div></div>
        <div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div class="small">Nilai</div><div id="resScore" style="font-weight:800"></div></div>
      </div>
      <div style="height:8px"></div>
      <div class="small">Waktu pengerjaan: <span id="resTime">00:00</span></div>
      <div style="height:8px"></div>
      <div class="small">Nama: <span id="resName">-</span> | Kelas: <span id="resClass">-</span> | Absen: <span id="resAbsen">-</span></div>
      <div style="height:8px"></div>
      <div class="wrong-list" id="wrongList"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="doneBtn">Selesai</button>
        <button class="btn outline" id="replayBtn">Ulangi Soal</button>
        <button class="btn outline" onclick="goBack()">Kembali</button>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn outline" id="shareWhats">Kirim ke Guru via WhatsApp</button>
        <button class="btn outline" id="copyResult">Salin Pesan</button>
      </div>
      <div id="sharePreview" style="margin-top:8px" class="small"></div>
    </div>

    <div id="riwayat" class="card" style="display:none">
      <strong>Riwayat Latihan</strong>
      <div style="height:8px"></div>
      <div class="small">Identitas: <span id="histIdent">-</span></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="sendAllHistory()">Kirim Semua ke Guru</button>
        <button class="btn outline" onclick="copyAllHistory()">Salin Semua Riwayat</button>
        <button class="btn outline" onclick="clearAllHistory()">Hapus Semua Riwayat</button>
      </div>
      <div style="height:8px"></div>
      <div class="table-scroll"><div id="historyList"></div></div>
    </div>

  </div>

  <footer class="app-footer">
    <nav class="nav" role="navigation" aria-label="navigasi utama">
      <button id="navHome" onclick="navClick('cover')">üè†<span>Home</span></button>
      <button id="navDaftar" onclick="navClick('daftar')">üìò<span>Daftar</span></button>
      <button id="navDrill" onclick="navClick('drill')">üß©<span>Drill</span></button>
      <button id="navProgress" onclick="navClick('progress')">üìà<span>Progres</span></button>
      <button id="navKali" onclick="navClick('latihan_mul')">‚úñÔ∏è<span>Kali</span></button>
      <button id="navBagi" onclick="navClick('latihan_div')">‚ûó<span>Bagi</span></button>
      <button id="navRiwayat" onclick="navClick('riwayat')">üìä<span>Riwayat</span></button>
    </nav>
  </footer>
</div>

<script>
/* Keys */
const LS_KEY_ID = 'bppi_identity_v4.6';
const LS_KEY_HISTORY = 'bppi_history_v4.6';
const LS_KEY_TEACHER = 'bppi_teacher_v4.6';
const LS_KEY_PROGRESS = 'bppi_progress_v4.6';

/* Navigation + panels */
let currentPanel=null, historyStack=[];
function showPanel(id){
  const panels=['mainMenu','cover','konsep','daftar','drill','progress','latihan_mul','latihan_div','quizView','resultView','riwayat'];
  panels.forEach(p=>{
    const el=document.getElementById(p);
    if(el) el.style.display=(p===id)?'block':'none';
  });
  currentPanel=id;
  updateNavActive();
  updateHeaderBackVisibility();
}
function navigate(id){
  if(currentPanel && currentPanel!==id) historyStack.push(currentPanel);
  showPanel(id);
}
function navClick(id){
  if(currentPanel && currentPanel!==id) historyStack.push(currentPanel);
  showPanel(id);
}
function goBack(){
  if(historyStack.length>0) showPanel(historyStack.pop());
  else showPanel('mainMenu');
}
function headerBack(){
  goBack();
}
function updateNavActive(){
  [['navHome','cover'],['navDaftar','daftar'],['navDrill','drill'],['navProgress','progress'],['navKali','latihan_mul'],['navBagi','latihan_div'],['navRiwayat','riwayat']].forEach(pair=>{
    const el=document.getElementById(pair[0]);
    if(!el) return;
    el.classList.toggle('active', currentPanel===pair[1]);
  });
}
function updateHeaderBackVisibility(){
  const btn=document.getElementById('headerBack');
  if(!btn) return;
  // hide on cover/mainMenu
  if(currentPanel==='cover' || currentPanel==='mainMenu') btn.style.display='none';
  else btn.style.display='inline-flex';
}

/* Identity */
function loadIdentityObj(){
  const raw=localStorage.getItem(LS_KEY_ID);
  return raw?JSON.parse(raw):{name:'',cls:'',abs:''};
}
function loadIdentity(){
  const raw=localStorage.getItem(LS_KEY_ID);
  if(raw){
    try{
      const o=JSON.parse(raw);
      document.getElementById('inputName').value=o.name||'';
      document.getElementById('inputClass').value=o.cls||'';
      document.getElementById('inputAbsen').value=o.abs||'';
      updateIdentityDisplay(o.name,o.cls,o.abs);
      document.getElementById('miniIdent').innerText=(o.name||'-')+' | '+(o.cls||'-')+' | '+(o.abs||'-');
      document.getElementById('progIdent').innerText=(o.name||'-')+' | '+(o.cls||'-')+' | '+(o.abs||'-');
      document.getElementById('histIdent').innerText=(o.name||'-')+' | '+(o.cls||'-')+' | '+(o.abs||'-');
    }catch(e){
      console.error("Error parsing identity:", e);
      localStorage.removeItem(LS_KEY_ID);
      updateIdentityDisplay('-','-','-');
    }
  } else updateIdentityDisplay('-','-','-');
}
function saveIdentity(){
  const name=document.getElementById('inputName').value.trim();
  const cls=document.getElementById('inputClass').value.trim();
  const abs=document.getElementById('inputAbsen').value.trim();
  const id={name,cls,abs};
  localStorage.setItem(LS_KEY_ID, JSON.stringify(id));
  updateIdentityDisplay(name,cls,abs);
  document.getElementById('miniIdent').innerText=(name||'-')+' | '+(cls||'-')+' | '+(abs||'-');
  document.getElementById('progIdent').innerText=(name||'-')+' | '+(cls||'-')+' | '+(abs||'-');
  document.getElementById('histIdent').innerText=(name||'-')+' | '+(cls||'-')+' | '+(abs||'-');
  alert('Identitas tersimpan.');
}
function updateIdentityDisplay(name,cls,abs){
  document.getElementById('showName').innerText=name||'-';
  document.getElementById('showClass').innerText=cls||'-';
  document.getElementById('showAbsen').innerText=abs||'-';
}
function clearIdentity(){
  if(!confirm('Hapus identitas, riwayat, dan progres belajar?')) return;
  localStorage.removeItem(LS_KEY_ID);
  localStorage.removeItem(LS_KEY_HISTORY);
  localStorage.removeItem(LS_KEY_PROGRESS);
  document.getElementById('inputName').value='';
  document.getElementById('inputClass').value='';
  document.getElementById('inputAbsen').value='';
  updateIdentityDisplay('-','-','-');
  document.getElementById('miniIdent').innerText='- | - | -';
  document.getElementById('progIdent').innerText='-';
  document.getElementById('histIdent').innerText='-';
  renderHistory();
  renderProgressGrid();
  alert('Identitas, Riwayat, dan Progres Belajar dihapus.');
}

/* Mul rendering */
const MUL_COLORS=['#2b8cff','#2ecc71','#f3d66a','#f29d43','#b28fe6','#0b76c2','#16a34a','#f59e0b','#f97316','#9333ea'];
function renderMul(){
  const sel=document.getElementById('mulSelect').value;
  const grid=document.getElementById('mulGrid');
  grid.innerHTML='';
  if(sel.includes('-')){
    const p=sel.split('-');
    const from=parseInt(p[0]);
    const to=parseInt(p[1]);
    for(let n=from;n<=to;n++) grid.appendChild(createMulCol(n));
  } else grid.appendChild(createMulCol(parseInt(sel)));
}
function createMulCol(n){
  const div=document.createElement('div');
  div.className='mul-col';
  const color=MUL_COLORS[(n-1)%MUL_COLORS.length];
  div.style.background=`linear-gradient(180deg, ${shade(color,0.06)}, ${color})`;
  const h=document.createElement('h4');
  h.innerText='Perkalian '+n;
  div.appendChild(h);
  for(let i=1;i<=10;i++){
    const p=document.createElement('p');
    p.innerText = i+' √ó '+n+' = '+(i*n);
    p.style.margin='4px 0';
    div.appendChild(p);
  }
  return div;
}
function shade(hex,percent){
  try{
    const c=hex.replace('#','');
    const num=parseInt(c,16);
    let r=(num>>16)+Math.round(255*percent);
    let g=((num>>8)&0x00FF)+Math.round(255*percent);
    let b=(num&0x0000FF)+Math.round(255*percent);
    r=Math.min(255,r);
    g=Math.min(255,g);
    b=Math.min(255,b);
    return '#'+((r<<16)|(g<<8)|b).toString(16).padStart(6,'0');
  }catch(e){return hex;}
}

// --- NEW HELPER FUNCTIONS FOR PARAMETER BUTTONS ---
function getSelectedParam(id){
  const el = document.getElementById(id);
  const selectedBtn = el.querySelector('.param-btn.selected');
  return selectedBtn ? selectedBtn.dataset.value : null;
}
function setupParamButtons(){
  document.querySelectorAll('.param-grid').forEach(grid => {
    grid.addEventListener('click', (e) => {
      if (e.target.classList.contains('param-btn')) {
        // Hapus kelas 'selected' dari semua tombol di grid ini
        grid.querySelectorAll('.param-btn').forEach(btn => btn.classList.remove('selected'));
        // Tambahkan kelas 'selected' pada tombol yang diklik
        e.target.classList.add('selected');
      }
    });
  });
}
// ----------------------------------------------------

/* Quiz engine */
let quizState=null, quizCallbackReplay=null, returnPanelAfterQuiz=null; // returnPanelAfterQuiz added

// MODIFIKASI: Menggunakan getSelectedParam dan shuffle
function startDrill(){
  const table=parseInt(document.getElementById('drillMul').value,10);
  const count=parseInt(getSelectedParam('drillCount'),10);
  const per=parseInt(getSelectedParam('drillDiff'),10);
  const mode=getSelectedParam('drillMode');
  if(!count || !per || !mode){ alert('Pilih semua parameter latihan drill.'); return; }
  
  const list=[];
  for(let i=1;i<=count;i++){
    const baseFactor = (i % 10) + 1; // Mendapatkan faktor 1 hingga 10 secara berulang
    
    let factorA = table;
    let factorB = baseFactor;

    // PENGACAKAN FAKTOR: Tukar posisi faktor A dan B (50% peluang)
    if(Math.random() < 0.5){
        factorA = baseFactor;
        factorB = table;
    }

    const q=`${factorA} √ó ${factorB}`;
    const a=factorA*factorB;

    list.push({q, a, tExp:per, meta:{kind:'Drill Perkalian', table:table, mode:mode, difficulty:per, count:count}});
  }

  // PENGACAKAN URUTAN SOAL: Acak seluruh daftar soal
  shuffleArray(list); 

  // FIX 1: bind replay button for drill
  quizCallbackReplay=()=>startDrill(); 
  returnPanelAfterQuiz='drill'; // Set return panel for Drill
  startQuiz({list, perDefault:per, type:'Latihan Drill Perkalian', drillMode:mode, detail:`Perkalian ${table} (${labelDifficulty(per)})`, meta:{table:table, mode:mode, difficulty:per, count:count}}); 
}

function startMulPractice(){
  const type=getSelectedParam('mulType');
  const count=parseInt(getSelectedParam('mulCount'),10);
  const per=parseInt(getSelectedParam('mulDiff'),10);
  const mode=getSelectedParam('mulMode');
  if(!type || !count || !per || !mode){ alert('Pilih semua parameter latihan perkalian.'); return; }

  let min=1, max=10;
  if(type==='1-5'){ max=5; }
  else if(type==='6-10'){ min=6; }
  
  const list=[];
  for(let i=0;i<count;i++){
    const f1=Math.floor(Math.random()*(max-min+1))+min;
    const f2=Math.floor(Math.random()*(10-1+1))+1;
    list.push({q:f1+' √ó '+f2, a:f1*f2, tExp:per, meta:{kind:'Latihan Perkalian', type:type, mode:mode, difficulty:per, count:count}});
  }
  // TAMBAHKAN: Acak urutan soal
  shuffleArray(list);

  quizCallbackReplay=()=>startMulPractice();
  returnPanelAfterQuiz='latihan_mul'; // Set return panel for Latihan Perkalian
  startQuiz({list, perDefault:per, type:'Latihan Perkalian', drillMode:mode, detail:`Perkalian ${type} (${labelDifficulty(per)})`, meta:{type:type, mode:mode, difficulty:per, count:count}});
}

// Fungsi Fisher-Yates Shuffle untuk mengacak urutan array
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function startDivPractice(){
  const count=parseInt(getSelectedParam('divCount'),10);
  const per=parseInt(getSelectedParam('divDiff'),10);
  const range=getSelectedParam('divRange');
  const mode=getSelectedParam('divMode');
  if(!count || !per || !range || !mode){ alert('Pilih semua parameter latihan pembagian.'); return; }

  let maxDivisor=range==='1-20'?20:10;
  
  const list=[];
  const uniqueQMap = new Map(); // Untuk melacak soal unik (mencegah duplikasi)

  // MENGGUNAKAN WHILE untuk memastikan jumlah soal yang diminta tercapai
  let attempts = 0;
  const MAX_ATTEMPTS = count * 5; // Batasi percobaan untuk mencegah loop tak terbatas

  while(list.length < count && attempts < MAX_ATTEMPTS){
    attempts++;
    
    // 1. Logika pembuatan soal
    const divisor=Math.floor(Math.random()*maxDivisor)+1;
    let quotient=Math.floor(Math.random()*10)+1;
    if(quotient===0) quotient=1; // memastikan hasil bagi tidak 0
    
    const dividend=divisor*quotient;
    
    // Cek batasan (dividend<=100) dan cek keunikan
    if(dividend<=100) {
        const qText = dividend+' √∑ '+divisor;
        
        if(!uniqueQMap.has(qText)){
            // Soal unik ditemukan
            uniqueQMap.set(qText, true); 
            list.push({
                q:qText,
                a:quotient,
                tExp:per, 
                meta:{kind:'Latihan Pembagian',range:range,mode:mode,difficulty:per,count:count}
            }); 
        }
    }
  }
  
  // Asumsi fungsi shuffleArray sudah ada
  shuffleArray(list); 

  quizCallbackReplay=()=>startDivPractice();
  returnPanelAfterQuiz='latihan_div'; // Set return panel for Latihan Pembagian
  startQuiz({list, perDefault:per, type:'Latihan Pembagian', drillMode:mode, detail:`Pembagian ${range} (${labelDifficulty(per)})`, meta:{range:range, mode:mode, difficulty:per, count:count}});
}

function startQuiz(opts){
  if(quizState && quizState.timerId) clearInterval(quizState.timerId);
  quizState={
    list:opts.list.slice(),
    index:0,
    answers:[],
    startTime:Date.now(),
    totalTimeUsed:0,
    perDefault:opts.perDefault||10,
    timerId:null,
    timeLeft:0,
    timePerQ:opts.perDefault||10,
    type:opts.type||'Latihan',
    drillMode:opts.drillMode||'input',
    detail:opts.detail||'',
    meta:opts.meta||{},
    level:opts.perDefault
  };
  document.getElementById('qTotal').innerText = quizState.list.length;
  document.getElementById('qIndex').innerText = 1;
  showPanel('quizView');
  showQuestion();
  enableKeyboardForQuiz(true);
}

function showQuestion(){
  const s=quizState;
  if(!s) return;
  if(s.index>=s.list.length){
    finishQuiz();
    return;
  }
  const item=s.list[s.index];
  document.getElementById('questionText').innerText = item.q + ' = ?';
  document.getElementById('infoText').innerText='';
  document.getElementById('answerDisplay').innerText='-';
  document.getElementById('qIndex').innerText = s.index+1;
  s.timePerQ = item.tExp || s.perDefault;

  if(s.drillMode==='mcq'){
    document.getElementById('inputArea').style.display='none';
    document.getElementById('mcqArea').style.display='block';
    buildMCQOptions(item.a);
  } else {
    document.getElementById('mcqArea').style.display='none';
    document.getElementById('inputArea').style.display='block';
  }

  startTimer(s.timePerQ);
  s.questionStart = Date.now();
}

function buildMCQOptions(correct){
  const optsEl=document.getElementById('mcqOptions');
  optsEl.innerHTML='';

  let choices=[correct];
  while(choices.length<4){
    const delta=Math.floor(Math.random()*7)+1;
    const sign=Math.random()<0.5?-1:1;
    let cand = correct + sign*delta;
    if(cand<=0) cand = Math.abs(cand)+2; // Jangan sampai 0
    // Pastikan pilihan ganda tidak melebihi 100 untuk perkalian/pembagian standar
    if(cand > 100) cand = correct - delta;
    if(cand<=0) cand=correct+1; // minimal 1

    if(!choices.includes(cand)) choices.push(cand);
  }

  choices=shuffle(choices);
  choices.forEach(ch=>{
    const b=document.createElement('button');
    b.className='mcq-btn';
    b.innerText=ch;
    b.onclick=()=>{
      const isCorrect=(ch===correct);
      b.classList.add('selected');
      b.classList.add(isCorrect?'correct':'wrong');
      setTimeout(()=>{
        recordAnswer(ch,false);
      },300);
    };
    optsEl.appendChild(b);
  });
}

function startTimer(seconds){
  stopTimer();
  quizState.timePerQ=seconds;
  quizState.timeLeft=seconds;
  updateTimerDisplay(quizState.timeLeft);
  updateProgress();
  quizState.timerId=setInterval(()=>{
    quizState.timeLeft--;
    if(quizState.timeLeft<0) {
      stopTimer();
      recordAnswer(null, true);
    } else {
      updateTimerDisplay(quizState.timeLeft);
      updateProgress();
    }
  },1000);
}
function stopTimer(){
  if(quizState && quizState.timerId) clearInterval(quizState.timerId);
  if(quizState) quizState.timerId=null;
}
function updateTimerDisplay(time){
  const el=document.getElementById('timer');
  const minutes=Math.floor(time/60);
  const seconds=time%60;
  el.innerText = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  if(time<=5) el.style.color='red';
  else el.style.color='var(--muted)';
}
function updateProgress(){
  const progressEl=document.getElementById('progressBar');
  if(quizState && quizState.timePerQ){
    const pct = (quizState.timeLeft / quizState.timePerQ) * 100;
    progressEl.style.width = pct+'%';
    if(pct<30) progressEl.style.background='red';
    else if(pct<60) progressEl.style.background='orange';
    else progressEl.style.background='var(--primary)';
  } else progressEl.style.width='100%';
}

function pressKey(key){
  const current=document.getElementById('answerDisplay').innerText;
  if(current==='-') document.getElementById('answerDisplay').innerText = key;
  else document.getElementById('answerDisplay').innerText += key;
}
function pressBack(){
  const current=document.getElementById('answerDisplay').innerText;
  if(current.length>1) document.getElementById('answerDisplay').innerText = current.slice(0,-1);
  else document.getElementById('answerDisplay').innerText = '-';
}
function submitAnswer(){
  const answerStr=document.getElementById('answerDisplay').innerText;
  if(answerStr==='-' || answerStr==='') return;
  recordAnswer(parseInt(answerStr,10), false);
}

function recordAnswer(givenAnswer, timedOut){
  stopTimer();
  const item=quizState.list[quizState.index];
  const isCorrect = givenAnswer===item.a;
  const timeTaken = Math.round((Date.now() - quizState.questionStart) / 1000);
  quizState.totalTimeUsed += timeTaken;

  quizState.answers.push({
    q: item.q,
    expected: item.a,
    given: givenAnswer,
    correct: isCorrect,
    timedOut: timedOut,
    time: timeTaken
  });
  
  // --- MULAI PERUBAHAN ---
  const infoTextEl = document.getElementById('infoText');
  const questionTextEl = document.getElementById('questionText');

  // Hapus semua kelas hasil sebelum menampilkan hasil baru
  infoTextEl.classList.remove('show-result', 'correct', 'wrong');
  
  // Hapus pewarnaan pada soal
  questionTextEl.style.color='inherit'; 
  
  if(!isCorrect) {
    infoTextEl.innerText = timedOut ? '‚ùå Waktu Habis!' : '‚ùå Salah!';
    infoTextEl.classList.add('wrong'); // Tambahkan kelas warna Merah
    
    // Tampilkan pesan hasil (opacity: 1)
    infoTextEl.classList.add('show-result'); 
    
    setTimeout(()=>{
      // Sembunyikan pesan hasil dan lanjut ke soal berikutnya
      infoTextEl.classList.remove('show-result', 'wrong');
      quizState.index++;
      showQuestion();
    }, 500);
  } else {
    infoTextEl.innerText = '‚úÖ Benar!';
    infoTextEl.classList.add('correct'); // Tambahkan kelas warna Accent
    
    // Tampilkan pesan hasil (opacity: 1)
    infoTextEl.classList.add('show-result'); 
    
    setTimeout(()=>{
      // Sembunyikan pesan hasil dan lanjut ke soal berikutnya
      infoTextEl.classList.remove('show-result', 'correct');
      quizState.index++;
      showQuestion();
    }, 300);
  }
  // --- AKHIR PERUBAHAN ---
}

function endQuizEarly(){
  if(!confirm('Apakah Anda yakin ingin menyelesaikan latihan lebih awal?')) return;
  stopTimer();
  finishQuiz();
}

function enableKeyboardForQuiz(enable){
  // Hanya aktifkan/nonaktifkan penanganan Enter
  if(enable){
    document.addEventListener('keydown', handleQuizKeydown);
  } else {
    document.removeEventListener('keydown', handleQuizKeydown);
  }
}

function handleQuizKeydown(e){
  // Hanya proses jika di panel kuis dan mode isian
  if(currentPanel !== 'quizView' || quizState.drillMode === 'mcq') return;

  const key = e.key;
  if (key >= '0' && key <= '9') {
    pressKey(key);
  } else if (key === 'Enter') {
    submitAnswer();
  } else if (key === 'Backspace') {
    pressBack();
  }
}

function finishQuiz(){
  stopTimer();
  const total=quizState.list.length;
  const correct=quizState.answers.filter(a=>a.correct).length;
  const wrong=total-correct;
  const pct=Math.round((correct/total)*100);
  const quizReturnPanel = returnPanelAfterQuiz; // capture return panel
  
  // --- 1. LOGIKA PUJIAN (BARU) ---
  let praiseText = '';
  if (pct === 100) {
      praiseText = 'ü§© *HEBAT! Kerja yang luar biasa!* ü•≥ Anda mendapat nilai sempurna!';
  } else if (pct >= 90) {
      praiseText = 'üëç *BAGUS SEKALI!* Hanya sedikit lagi menuju sempurna.';
  }
  document.getElementById('resPraise').innerHTML = praiseText;
  
  // --- 2. TAMPILKAN HASIL BIASA ---
  document.getElementById('resCorrect').innerText = correct;
  document.getElementById('resWrong').innerText = wrong;
  document.getElementById('resScore').innerText = pct+'%';
  document.getElementById('resTime').innerText = formatSecondsFull(quizState.totalTimeUsed);
  const id=loadIdentityObj();
  document.getElementById('resName').innerText = id.name||'-';
  document.getElementById('resClass').innerText = id.cls||'-';
  document.getElementById('resAbsen').innerText = id.abs||'-';
  const wl=document.getElementById('wrongList'); wl.innerHTML='';
  quizState.answers.forEach((a,i)=>{
    const d=document.createElement('div');
    d.style.padding='6px'; d.style.borderBottom='1px solid #f3f3f3';
    d.innerHTML = '<strong>'+(i+1)+'.</strong> '+a.q+' = <strong>'+a.expected+'</strong><br/><span class="small">Jawaban: '+(a.given===null?'‚Äî':a.given)+(a.timedOut? ' (waktu habis)':'')+' | Waktu: '+a.time+' s</span>';
    if(!a.correct) d.style.background='#fff7f7';
    wl.appendChild(d);
  });
  
  // auto save history
  const entry = {
    idName:id.name||'',
    idClass:id.cls||'',
    idAbsen:id.abs||'',
    type: quizState.type||'',
    detail: quizState.detail||'',
    count: quizState.list.length,
    correct: correct,
    wrong: wrong,
    score: pct,
    timeSecs: quizState.totalTimeUsed,
    date: (new Date()).toISOString(),
    mode: quizState.drillMode, // <--- TAMBAHAN BARU: Mode
    metaSummary: extractMetaSummary(quizState),
    meta: quizState.meta||{}
  };
  addHistoryEntry(entry);
  // update progress
  updateProgressDataFromEntry(entry);
  
  // --- 3. SIAPKAN PESAN BERBAGI (DIPASTIKAN BERSIH TANPA PUJIAN) ---
  const timeStr=formatSecondsFull(quizState.totalTimeUsed);
  const quizType = quizState.type||''; 
  const detail = quizState.detail||'';
  const mode = quizState.drillMode;
  const level = quizState.level;

  // Membuat pesan yang bersih (tidak menyertakan resPraise)
  const msg=`Hasil Latihan:\nNama: ${id.name||'-'}\nKelas: ${id.cls||'-'}\nNo. Absen: ${id.abs||'-'}\nJenis: ${quizType}\nDetail: ${detail}\nMode: ${getModeName(mode)}\nSkor: ${correct}/${total} (${pct}%)\nWaktu: ${timeStr}\nLevel: ${getLevelName(level)}`;

  document.getElementById('shareWhats').dataset.msg = encodeURIComponent(msg);
  document.getElementById('sharePreview').innerText = msg;

  // FIX 3: bind done button -> return to correct panel
  document.getElementById('doneBtn').onclick = ()=> {
    alert('Selesai. Hasil tersimpan di Riwayat.');
    showPanel(quizReturnPanel || 'mainMenu'); // Kembali ke panel latihan yang sesuai
    enableKeyboardForQuiz(false);
  };
  // FIX 4: bind replay button
  document.getElementById('replayBtn').onclick = ()=> {
    if(typeof quizCallbackReplay==='function') quizCallbackReplay();
    else alert('Tidak ada sesi untuk diulang.');
  };
  
  showPanel('resultView');
  renderProgressGrid();
  renderHistory();
}

/* History management */
function loadHistory(){
  const raw=localStorage.getItem(LS_KEY_HISTORY);
  return raw?JSON.parse(raw):[];
}
function saveHistory(hist){
  localStorage.setItem(LS_KEY_HISTORY, JSON.stringify(hist));
}
function addHistoryEntry(entry){
  const hist = loadHistory();
  // Riwayat disimpan dari terbaru
  hist.unshift(entry);
  saveHistory(hist);
  // renderHistory dipanggil di finishQuiz
}
function clearAllHistory(){
  if(!confirm('Hapus SEMUA riwayat latihan? Tindakan ini tidak dapat dibatalkan. Riwayat dan Progres Belajar akan hilang.')) return;
  localStorage.removeItem(LS_KEY_HISTORY);
  localStorage.removeItem(LS_KEY_PROGRESS);
  renderHistory();
  renderProgressGrid();
  alert('Semua riwayat dan progres berhasil dihapus.');
}

// PERUBAHAN RIWAYAT: Fungsi renderHistory() diubah total
function renderHistory(){
  // Menggunakan loadHistory(), yang sudah tersimpan dengan urutan: Terbaru di index 0
  const hist = loadHistory(); 
  const container=document.getElementById('historyList');
  container.innerHTML='';

  if(hist.length===0){
    container.innerHTML='<div class="small">Belum ada riwayat latihan.</div>';
    return;
  }

  const table=document.createElement('table');
  table.className='hist';
  table.style.width='100%';
  table.style.borderCollapse='collapse';
  
  const thead=document.createElement('thead');
  thead.innerHTML='<tr><th>No</th><th>Tanggal</th><th>Jenis Latihan</th><th>Detail</th><th>Mode</th><th>Skor</th><th>Waktu</th></tr>';
  table.appendChild(thead);

  const tbody=document.createElement('tbody');
  // hist sudah terurut dari terbaru ke terlama, jadi loop ini akan menampilkannya dengan benar.
  hist.forEach((h,idx)=>{
    const row=document.createElement('tr');
    
    let scoreClass = '';
    if(h.score === 100) scoreClass = 'score-100';
    else if(h.score < 60) scoreClass = 'score-60';
    row.className = scoreClass;
    
    const modeText = getModeName(h.mode) || '-'; 
    
    row.innerHTML=`
      <td>${idx+1}</td>
      <td>${new Date(h.date).toLocaleDateString('id-ID')}</td>
      <td style="text-align:left">${h.type}</td>
      <td style="text-align:left">${h.detail||'-'}</td>
      <td>${modeText}</td>
      <td>${h.score}%</td>
      <td>${formatSecondsFull(h.timeSecs)}</td>
    `;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

// FIX 5: Fungsi Helper untuk format waktu yang konsisten (dari prepareSharePreview)
function formatSecondsFull(sec){
  if(typeof sec!=='number') sec=Number(sec)||0;
  if(sec<60) return `${sec} detik`;
  const m=Math.floor(sec/60);
  const s=sec%60;
  return `${m} m ${s} d`;
}

function sendAllHistory(){
  const hist=loadHistory();
  if(hist.length===0){
    alert('Belum ada riwayat untuk dikirim.');
    return;
  }
  const id=loadIdentityObj();
  const saved=localStorage.getItem(LS_KEY_TEACHER);

  // FIX 5: Tambahkan identitas siswa di awal pesan
  let full='*Data Siswa:*%0ANama:%20'+encodeURIComponent(id.name||'-')+'%0AKelas:%20'+encodeURIComponent(id.cls||'-')+'%0ANo.%20Absen:%20'+encodeURIComponent(id.abs||'-')+'%0A%0A*Rekap Riwayat Latihan (Terbaru):*%0A';
  
  hist.forEach((h,idx)=>{
    // TAMBAH MODE di pesan
    const modeText = getModeName(h.mode) || '-';
    full += encodeURIComponent(`${idx+1}. ${h.type} (${modeText}) - ${h.detail||'-'} - Skor ${h.score}% - ${formatSecondsFull(h.timeSecs)} - ${new Date(h.date).toLocaleDateString('id-ID')}\n`);
  });

  if(!saved){
    if(confirm('Nomor guru belum disimpan. Mau salin pesan lengkap untuk dikirim manual?')){
      navigator.clipboard.writeText(decodeURIComponent(full).replace(/%0A/g, '\n').replace(/%20/g, ' ')).then(() => alert('Pesan rekap disalin.'));
    }
    return;
  }
  const url='https://wa.me/'+saved+'?text='+full;
  window.open(url,'_blank');
}

function copyAllHistory(){
  const hist=loadHistory();
  if(hist.length===0){
    alert('Belum ada riwayat.');
    return;
  }
  const id=loadIdentityObj();
  
  // FIX 5: Tambahkan identitas siswa di awal pesan
  let text=`Data Siswa:\nNama: ${id.name||'-'}\nKelas: ${id.cls||'-'}\nNo. Absen: ${id.abs||'-'}\n\nRekap Riwayat Latihan (Terbaru):\n`;
  
  hist.forEach((h,idx)=>{
    // TAMBAH MODE di pesan
    const modeText = getModeName(h.mode) || '-';
    text += `${idx+1}. ${h.type} (${modeText}) - ${h.detail||'-'} - Skor ${h.score}% - ${formatSecondsFull(h.timeSecs)} - ${new Date(h.date).toLocaleDateString('id-ID')}\n`;
  });
  navigator.clipboard.writeText(text).then(()=> alert('Rekap riwayat disalin.'));
}

/* Teacher phone */
function formatPhone(input){
  let s=input.replace(/\s/g,'').replace(/[^0-9+]/g,'');
  if(s.startsWith('+62')) s='62'+s.substring(3);
  if(s.startsWith('0')) s='62'+s.substring(1);
  if(!s.startsWith('62')) s='62'+s;
  return s;
}
function saveTeacher(){
  const num=document.getElementById('teacherNumber').value.trim();
  if(!num) { localStorage.removeItem(LS_KEY_TEACHER); document.getElementById('teacherSaved').innerText='Nomor Guru terhapus.'; return; }
  const formatted=formatPhone(num);
  localStorage.setItem(LS_KEY_TEACHER, formatted);
  document.getElementById('teacherSaved').innerText='Nomor tersimpan: '+formatted;
  alert('Nomor WhatsApp Guru tersimpan.');
}

/* Progress logic */
function loadProgress(){
  const raw=localStorage.getItem(LS_KEY_PROGRESS);
  return raw?JSON.parse(raw):{};
}
function saveProgress(prog){
  localStorage.setItem(LS_KEY_PROGRESS, JSON.stringify(prog));
}
function updateProgressDataFromEntry(entry){
  // Hanya proses Drill Perkalian
  if(entry.type !== 'Latihan Drill Perkalian') return;

  try{
    const prog=loadProgress();
    const tables=parseTablesFromDetail(entry.detail);
    const score=entry.score;
    const mode=entry.meta.mode;
    const difficulty=entry.meta.difficulty;
    const count=entry.meta.count;
    
    tables.forEach(table=>{
      if(!prog[table]) prog[table]={records:[], bestScore:0};
      
      // Update best score
      if(score > prog[table].bestScore) prog[table].bestScore = score;
      
      // Kriteria Hafal (REVISI SKOR): Skor MINIMAL 90% pada Sukar (5s) dengan jumlah 10 atau 15
      if(score>=90 && difficulty===5 && (count===10 || count===15)){
        const key=`${mode}-${difficulty}-${count}`;
        if(!prog[table].mastery) prog[table].mastery={};
        prog[table].mastery[key]=true;
      }

      // Simpan record
      prog[table].records.push({score, mode, difficulty, count, date:entry.date});
      // Sort dan batasi (misalnya 10 record terakhir)
      prog[table].records.sort((a,b)=>new Date(b.date)-new Date(a.date));
      prog[table].records=prog[table].records.slice(0,10);
    });
    saveProgress(prog);
  } catch(e) {
    console.warn('updateProgressDataFromEntry failed', e);
  }
}
function parseTablesFromDetail(detail){
  const res=[];
  if(!detail) return res;

  const mRange = detail.match(/Perkalian\s*([0-9]+)\s*[‚Äì-]\s*([0-9]+)/i); // Handle '‚Äì' (en dash) and '-' (hyphen)
  if(mRange){
    const from=parseInt(mRange[1]), to=parseInt(mRange[2]);
    for(let i=from;i<=to;i++) res.push(i);
    return res;
  }
  const mSingle = detail.match(/Perkalian\s*([0-9]+)/i);
  if(mSingle){
    res.push(parseInt(mSingle[1],10));
    return res;
  }
  
  return res;
}
// Revisi 3: Fungsi untuk Kirim Progres
function sendProgress(){
  const p = loadProgress();
  const id = loadIdentityObj();
  const saved = localStorage.getItem(LS_KEY_TEACHER);
  if (!saved) {
    if (confirm('Nomor guru belum disimpan. Mau salin pesan progres untuk dikirim manual?')) {
      copyProgress();
    }
    return;
  }
  const msg = makeProgressMessage(p, id);
  const url = 'https://wa.me/' + saved + '?text=' + encodeURIComponent(msg);
  window.open(url, '_blank');
}
// Revisi 3: Fungsi untuk Salin Progres
function copyProgress(){
  const p = loadProgress();
  const id = loadIdentityObj();
  const msg = makeProgressMessage(p, id);
  navigator.clipboard.writeText(msg).then(() => alert('Pesan progres disalin.'));
}
// Revisi 3: Fungsi Helper untuk membuat pesan Progres (Format WA)
function makeProgressMessage(progressData, identity){
  let msg = `*LAPORAN PROGRES BELAJAR PERKALIAN*\n`;
  msg += `Nama: ${identity.name||'-'}\nKelas: ${identity.cls||'-'}\nNo. Absen: ${identity.abs||'-'}\n\n`;
  // PERUBAHAN TEKS LAPORAN WA
  msg += `*Status Hafalan (Skor Min. 90% pada Level Sukar 5s, Soal 10/15):*\n`;
  
  let allMastered = true;
  for (let i = 1; i <= 10; i++) {
    const p = progressData[i];
    let status = '‚ùå BELUM HAFAL: ';
    let score = '0%';
    let isMastered = false;

    if(p && p.mastery){
      const mcqMastered = p.mastery['mcq-5-10'] || p.mastery['mcq-5-15'];
      const inputMastered = p.mastery['input-5-10'] || p.mastery['input-5-15'];
      
      if(mcqMastered && inputMastered){
        status = '‚úÖ HAFAL: ';
        isMastered = true;
      } else if(mcqMastered || inputMastered){
        status = '‚ö†Ô∏è BELUM LENGKAP: ';
        isMastered = false;
      }
    }

    if (!isMastered) allMastered = false;
    if(p && p.bestScore) score = p.bestScore + '%';

    msg += `Perkalian ${i}: ${status} (Skor Terbaik: ${score})\n`;
  }

  msg += `\n*REKAP KESIMPULAN:* ${allMastered ? 'SELURUH PERKALIAN 1-10 SUDAH DIKUASAI LUNAS!' : 'MASIH ADA YANG HARUS DIHAFAL LENGKAP!'}`;

  return msg;
}


function getProgressState(table, progressData){
  const p=progressData[table];
  if(!p) return 'red';

  const mcqMastered = (p.mastery && (p.mastery['mcq-5-10'] || p.mastery['mcq-5-15']));
  const inputMastered = (p.mastery && (p.mastery['input-5-10'] || p.mastery['input-5-15']));

  if(mcqMastered && inputMastered) return 'green';
  if(p.records.length > 0) return 'yellow'; // Sudah pernah mencoba, tapi belum lunas
  return 'red';
}
function renderProgressGrid(){
  const container=document.getElementById('progressGrid');
  container.innerHTML='';
  const p = loadProgress();

  for(let i=1;i<=10;i++){
    const state=getProgressState(i,p);
    const box=document.createElement('div');
    box.className=`prog-box ${state}`;
    
    let icon = '‚ùå';
    let label = 'Belum';
    if(state==='green') { icon='‚úÖ'; label='Hafal'; }
    else if(state==='yellow') { icon='‚ö†Ô∏è'; label='Latihan'; }
    
    box.innerHTML=`<div class="label">P. ${i}</div><div class="icon">${icon}</div><div class="label">${label}</div>`;
    box.onclick=()=>{
      // RIWAYAT DI PROGRES: ditampilkan TERBARU DI ATAS (records sudah terurut di updateProgressDataFromEntry)
      const recs = (p[i] && p[i].records) ? p[i].records : []; 
      let msg = `Perkalian ${i}\nStatus: ${state==='green'?'Hafal':state==='yellow'?'Sudah Pernah Coba':'Belum pernah'}\nSkor terbaik: ${p[i]?p[i].bestScore+'%':'-'}\n\nRiwayat (terbaru):\n`;
      
      if(recs.length===0) msg += '- belum ada riwayat -';
      else recs.slice(0,8).forEach((r,idx)=>{
        const modeText = getModeName(r.mode) || '-';
        msg += `${idx+1}. Mode:${modeText} | Dif:${r.difficulty}s | Soal:${r.count} | Skor:${r.score}% | ${new Date(r.date).toLocaleDateString('id-ID')}\n`;
      });
      alert(msg);
    };
    container.appendChild(box);
  }
}

/* helpers: extract meta summary to know which tables touched */
function extractMetaSummary(quizStateObj){
  try{
    const tables = [];
    quizStateObj.list.forEach(it => {
      if(it.meta && it.meta.table) tables.push(it.meta.table);
      else {
        const m = (it.q || '').match(/√ó\s*([0-9]+)/);
        if(m){
          const t = parseInt(m[1],10);
          if(!isNaN(t)) tables.push(t);
        }
      }
    });
    const unique = Array.from(new Set(tables));
    return { tables: unique };
  }catch(e){ return {}; }
}

function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function getModeName(mode){
  if(mode==='mcq') return 'P.Ganda'; // Disingkat agar muat di tabel
  if(mode==='input') return 'Isian';
  return '-';
}
function labelDifficulty(per){
  if(per===15) return 'Mudah';
  if(per===10) return 'Sedang';
  if(per===5) return 'Sukar';
  return '-';
}
function getLevelName(per){
  if(per===15) return 'Mudah';
  if(per===10) return 'Sedang';
  if(per===5) return 'Sukar';
  return '-';
}


/* init and bindings */
document.addEventListener('DOMContentLoaded', ()=>{
  loadIdentity();
  renderMul();
  renderHistory();
  renderProgressGrid();
  
  // Panggil fungsi untuk menyiapkan tombol parameter
  setupParamButtons();
  
  const t=localStorage.getItem(LS_KEY_TEACHER);
  if(t){ document.getElementById('teacherNumber').value=t; document.getElementById('teacherSaved').innerText='Nomor tersimpan: '+t; }
  
  showPanel('cover'); updateNavActive();
  
  // Perbarui binding share, karena pesan sekarang disiapkan di finishQuiz
  document.getElementById('copyResult').onclick=()=> navigator.clipboard.writeText(document.getElementById('sharePreview').innerText).then(()=> alert('Pesan disalin.'));
  document.getElementById('shareWhats').onclick=()=>{
    const saved=localStorage.getItem(LS_KEY_TEACHER);
    if(!saved){
      if(confirm('Nomor guru belum disimpan. Mau salin pesan untuk dikirim manual?')){
        navigator.clipboard.writeText(document.getElementById('sharePreview').innerText).then(()=> alert('Pesan disalin.'));
      }
      return;
    }
    const msg=document.getElementById('shareWhats').dataset.msg || '';
    window.open('https://wa.me/'+saved+'?text='+msg,'_blank');
  };

  document.getElementById('inputName').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveIdentity(); });
  document.getElementById('inputClass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveIdentity(); });
  document.getElementById('inputAbsen').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveIdentity(); });
});
</script>
</body>
</html>

